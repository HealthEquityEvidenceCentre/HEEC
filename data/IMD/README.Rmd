---
title: "Exploring the Impact of Dispensing Practices on Equity in NHS Payments to General Practices"
author: "Cameron Appel"
date: "2024-08-06"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```
# Index of Multiple Deprivation (IMD) Data
The Office for Health Improvement and Disparities (OHID), part of the Department of Health and Social Care (DHSC), provides the [Index of Multiple Deprivation (IMD) data](https://fingertips.phe.org.uk/search/deprivation%20index#page/4/gid/1/pat/159/par/K02000001/ati/15/are/E92000001/iid/93553/age/1/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1) - a measure of relative deprivation - at the practice level. This data is used to assess the socio-economic status of the population served by each practice.

### API
This data can be accessed through the [API](https://fingertips.phe.org.uk/api) provided by the Fingertips platform.
```{r API}
# Load necessary libraries
library(httr)
library(readr)
library(magrittr)
library(dplyr)

# Define the URL and query parameters
base_url <- "https://fingertipsws.phe.org.uk/api/all_data/csv/by_indicator_id"
query_params <- list(
  v = "/0-c459298b/",
  parent_area_code = "E92000001",
  parent_area_type_id = 167,
  child_area_type_id = 7,
  indicator_ids = 93553
)

# Make the API request
response <- GET(base_url, query = query_params)

# Check if the response is successful
if (http_status(response)$category == "Success") {
  # Write the content to a temporary file
  temp_file <- tempfile(fileext = ".csv")
  writeBin(content(response, "raw"), temp_file)

  # Read the CSV data
  IMD <- read_csv(temp_file)

  # Display the first few rows of the data
  print(head(IMD))
} else {
  cat("Failed to retrieve data. Status code:", status_code(response), "\n")
  cat("Response content:", content(response, "text"), "\n")
}

head(IMD)
```

### FingertipsR Package
The IMD data can also be accessed using the `fingertipsR` [package](https://github.com/ropensci/fingertipsR).

```{r fingertipsR}
# Load necessary library
library(fingertipsR)

# Get the profile ID for the Public Health Outcomes Framework
profiles_data <- profiles()
phof_profile <- profiles_data[profiles_data$ProfileName == "Public Health Outcomes Framework", ]
profile_id <- phof_profile$ProfileID[1]

# Print the profile details (optional)
print(phof_profile)

# Get indicators for the Public Health Outcomes Framework profile
indicators_data <- indicators(ProfileID = profile_id)

# Find the IndicatorID for "Deprivation score (IMD 2019)"
indicator_id <- indicators_data$IndicatorID[indicators_data$IndicatorName == "Deprivation score (IMD 2019)"]

# Print the indicator details (optional)
print(indicators_data[indicators_data$IndicatorName == "Deprivation score (IMD 2019)", ])

# Get the data for the "Deprivation score (IMD 2019)" indicator
IMD <- fingertips_data(IndicatorID = indicator_id, AreaTypeID = 7) # AreaTypeID 7 is for CCGs

# Display the first few rows of the data
head(IMD)
```

### Direct download
However, this data only provides values for practices that are still active in 2019. To get the data for all practices, we obtained the CSV directly from OHID via email, which is available [here](https://github.com/camappel/HEEC/blob/main/data/IMD/IMD_raw.csv) as `IMD_raw.csv`.

IMD values are only provided for 2010, 2015, and 2019. In order to have a continuous time series, we interpolate the values between these years, and extrapolate the values for 2020-2023. The resultant data is saved [here](https://github.com/camappel/HEEC/blob/main/data/IMD/IMD_interpolated.csv) as `IMD_interpolated.csv`.

```{r interpolate}
IMD <- read.csv("IMD_raw.csv")

IMD <- IMD[, c("AreaCode", "Value", "Year")]
IMD %<>% rename(., Practice.Code = AreaCode)
IMD %<>% rename(., IMD = Value)

### interpolate IMD
result_df <- data.frame()

for (i in unique(IMD$Practice.Code)) {
  has_2010 <- any(IMD$Practice.Code == i & IMD$Year == 2010)
  has_2015 <- any(IMD$Practice.Code == i & IMD$Year == 2015)
  has_2019 <- any(IMD$Practice.Code == i & IMD$Year == 2019)

  # if data is only available for 2010, extrapolate to 2011-2023
  if (has_2010 & !has_2015) {
    for (year in 2011:2023) {
      new_row <- data.frame(
        Year = year,
        Practice.Code = i,
        IMD = IMD[IMD$Practice.Code == i & IMD$Year == 2010, ]$IMD
      )

      # Append the new row to the result data frame
      result_df <- rbind(result_df, new_row)
    }
  }

  # if data is available for 2010 and 2015, interpolate to 2011-2014
  if (has_2010 & has_2015) {
    for (year in 2011:2014) {
      y_new <- approx(
        IMD[IMD$Practice.Code == i, ]$Year,
        IMD[IMD$Practice.Code == i, ]$IMD,
        xout = year
      )
      # Create a new row for the current year and AreaCode
      new_row <- data.frame(
        Year = year,
        Practice.Code = i,
        IMD = y_new$y
      )

      # Append the new row to the result data frame
      result_df <- rbind(result_df, new_row)
    }
  }

  # if data is available for 2015 but not 2019, extrapolate to 2016-2023
  if (has_2015 & !has_2019) {
    for (year in 2016:2023) {
      new_row <- data.frame(
        Year = year,
        Practice.Code = i,
        IMD = IMD[IMD$Practice.Code == i & IMD$Year == 2015, ]$IMD
      )

      # Append the new row to the result data frame
      result_df <- rbind(result_df, new_row)
    }
  }

  # if data is available for 2015 and 2019, interpolate to 2016-2018
  if (has_2015 & has_2019) {
    for (year in 2016:2018) {
      y_new <- approx(
        IMD[IMD$Practice.Code == i, ]$Year,
        IMD[IMD$Practice.Code == i, ]$IMD,
        xout = year
      )
      # Create a new row for the current year and AreaCode
      new_row <- data.frame(
        Year = year,
        Practice.Code = i,
        IMD = y_new$y
      )

      # Append the new row to the result data frame
      result_df <- rbind(result_df, new_row)
    }
  }

  # if data is available for 2019, extrapolate to 2020-2023
  if (has_2019) {
    for (year in 2020:2023) {
      new_row <- data.frame(
        Year = year,
        Practice.Code = i,
        IMD = IMD[IMD$Practice.Code == i & IMD$Year == 2019, ]$IMD
      )

      # Append the new row to the result data frame
      result_df <- rbind(result_df, new_row)
    }
  }
}

IMD <- rbind(IMD, result_df)

IMD <- IMD[order(IMD$Practice.Code, IMD$Year), ]
write.csv(IMD, "IMD_interpolated.csv", row.names = FALSE)

head(IMD)
```

```{r}
IMD %>%
  group_by(Year) %>%
  summarise(
    mean_IMD = mean(IMD, na.rm = TRUE),
    sd_IMD = sd(IMD, na.rm = TRUE),
    min_IMD = min(IMD, na.rm = TRUE),
    max_IMD = max(IMD, na.rm = TRUE),
    n = n()
  )
```