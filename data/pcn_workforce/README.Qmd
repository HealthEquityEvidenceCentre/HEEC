---
title: "General Practice Workforce"
author: "Cameron Appel"
date: "2024-08-20"
format: gfm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)

library(dplyr)
library(magrittr)
```

# General Practice Workforce
General Practice Workforce
NHS Digital provides public CSVs on the primary care general practice workforce.

Data is reported annually from September 2015-2020, quarterly from December 2020-June 2021, and monthly from July 2021 henceforth.

The practice-level headcount of fully-qualified permanent GPs (excluding GPs in training & locums) is denoted by the TOTAL_GP_EXTGL_HC column.
The practice-level FTE of administrative staff is denoted by the TOTAL_ADMIN_FTE column. These figures are broken down further by role type:
- Manager
- Management Partner
- Medical Secretary
- Receptionist
- Telephonist
- Estates and Ancillary

```{r 1}
# List all relevant files from the raw directory
files <- list.files("raw", pattern = "Primary Care Networks.*Individual Level.csv", full.names = TRUE)

# Load and combine all files
pcn <- lapply(files, function(file) {
  df <- read.csv(file)
  df <- df %>% 
    select(CENSUS_YEAR, 
           PCN_CODE, PCN_NAME, 
           ICB_CODE, ICB_NAME, STAFF_GROUP, 
           FTE)
  return(df)
}) %>% 
  bind_rows()
  
pcn %<>% rename(Year = CENSUS_YEAR)
```

# Get IMD from fingertipsR
```{r 2}
# Load necessary library
library(fingertipsR)

# Get the profile ID for the Public Health Outcomes Framework
profiles_data <- profiles()
phof_profile <- profiles_data[profiles_data$ProfileName == "Public Health Outcomes Framework", ]
profile_id <- phof_profile$ProfileID[1]

# Get indicators for the Public Health Outcomes Framework profile
indicators_data <- indicators(ProfileID = profile_id)

# Find the IndicatorID for "Deprivation score (IMD 2019)"
indicator_id <- indicators_data$IndicatorID[indicators_data$IndicatorName == "Deprivation score (IMD 2019)"]

# Get the data for the "Deprivation score (IMD 2019)" indicator
IMD <- fingertips_data(IndicatorID = indicator_id, AreaTypeID = 7) %>%
  select(c("ParentCode","Value")) %>% group_by(ParentCode) %>% summarise(IMD = mean(Value))

IMD %<>% rename(PCN_CODE = ParentCode)
# Display the first few rows of the data
head(IMD)
```

```{r 3}
pcn <- merge(pcn, IMD, by = "PCN_CODE") %>%
  group_by(Year) %>%
  mutate(IMD_quintile = ntile(IMD, 5))

# View the updated data frame
head(pcn)

write.csv(pcn, "pcn_workforce.csv")
```