---
title: "Exploring the Impact of Dispensing Practices on Equity in NHS Payments to General Practices"
author: "Your Name"
date: "2024-08-06"
output: 
  md_document:
    variant: markdown_github
---

# Exploring the impact of dispensing practicing on equity in NHS payments to general practices

General practices serving the most deprived populations receive less funding per weighted patient than those serving the least deprived. Here we show that this inequality is driven by a higher concentration of dispensing practices in more affluent areas.

### What are Dispensing Practices?

Dispensing practices are practices where “at the patient’s request dispensing doctors are allowed to dispense the medicines they prescribe for these patients” (DDA); they are not the same as practices with an on-site pharmacy.

## Data Analysis

[NHS Digital](https://digital.nhs.uk/data-and-information/publications/statistical/nhs-payments-to-general-practice) provides public CSVs on NHS payments to individual providers of general practice services in England from 2014-15 to 2022-23. We look at the most recent data from 2022-23.

```{r}
# Load necessary libraries
library(magrittr)
library(dplyr)

# Download the NHS payments data for 2022/23
df <- read.csv("https://files.digital.nhs.uk/05/E6ADA0/nhspaymentsgp-22-23-prac-csv.csv")

# Filter dispensing and non-dispensing practices
dispensing <- df %>% filter(Dispensing.Practice == "Yes")
non_dispensing <- df %>% filter(Dispensing.Practice == "No")

# Number of dispensing practices
num_dispensing <- dispensing %>%
  distinct(Practice.Code) %>%
  nrow()

# Number of non-dispensing practices
num_non_dispensing <- non_dispensing %>%
  distinct(Practice.Code) %>%
  nrow()

num_unknown_dispensing <- df[df$Dispensing.Practice == "Unknown", ] %>%
  distinct(Practice.Code) %>%
  nrow()

# Sum of patients in dispensing practices
total_dispensing_patients <- sum(dispensing$Average.Number.of.Registered.Patient, na.rm = TRUE)

# Sum of patients in non-dispensing practices
total_non_dispensing_patients <- sum(non_dispensing$Average.Number.of.Registered.Patient, na.rm = TRUE)
```

In 2023, there were `r num_dispensing` dispensing practices covering `r total_dispensing_patients` patients and `r num_non_dispensing` non-dispensing practices covering `r total_non_dispensing_patients` patients in England (dispensing status unknown for `r num_unknown_dispensing` practices).

OHID provides the Fingertips API, which includes practice-level IMD values.
```{r}
# Load necessary libraries
library(httr)
library(readr)

# Define the URL and query parameters
base_url <- "https://fingertipsws.phe.org.uk/api/all_data/csv/by_indicator_id"
query_params <- list(
  v = "/0-c459298b/",
  parent_area_code = "E92000001",
  parent_area_type_id = 167,
  child_area_type_id = 7,
  indicator_ids = 93553
)

# Make the API request
response <- GET(base_url, query = query_params)

# Check if the response is successful
if (http_status(response)$category == "Success") {
  # Write the content to a temporary file
  temp_file <- tempfile(fileext = ".csv")
  writeBin(content(response, "raw"), temp_file)

  # Read the CSV data
  df <- read_csv(temp_file)

  # Display the first few rows of the data
  print(head(df))
} else {
  cat("Failed to retrieve data. Status code:", status_code(response), "\n")
  cat("Response content:", content(response, "text"), "\n")
}
```

As well as the the fingertipsR package, which provides an R interface to the Fingertips API.

```{r}
# Enable repository from rOpenSci
options(repos = c(
  ropensci = "https://ropensci.r-universe.dev",
  CRAN = "https://cloud.r-project.org"
))

# Download and install fingertipsR in R
install.packages("fingertipsR")

# Alternatively, install the latest development version from GitHub
# install.packages("remotes")
remotes::install_github("rOpenSci/fingertipsR",
  build_vignettes = TRUE,
  dependencies = "suggests"
)
```

```{r}
# Load necessary library
library(fingertipsR)

# Get the profile ID for the Public Health Outcomes Framework
profiles_data <- profiles()
phof_profile <- profiles_data[profiles_data$ProfileName == "Public Health Outcomes Framework", ]
profile_id <- phof_profile$ProfileID[1]

# Print the profile details (optional)
print(phof_profile)

# Get indicators for the Public Health Outcomes Framework profile
indicators_data <- indicators(ProfileID = profile_id)

# Find the IndicatorID for "Deprivation score (IMD 2019)"
indicator_id <- indicators_data$IndicatorID[indicators_data$IndicatorName == "Deprivation score (IMD 2019)"]

# Print the indicator details (optional)
print(indicators_data[indicators_data$IndicatorName == "Deprivation score (IMD 2019)", ])

# Get the data for the "Deprivation score (IMD 2019)" indicator
data <- fingertips_data(IndicatorID = indicator_id, AreaTypeID = 7) # AreaTypeID 7 is for CCGs

# Display the first few rows of the data
head(data)
```

Conclusion
This analysis highlights the disparities in funding between general practices serving different populations and the role of dispensing practices in this inequality.

For more detailed exploration and visualization, further analysis and refinement of the data is needed.

References
NHS Digital: NHS Payments to General Practice
Fingertips API Documentation