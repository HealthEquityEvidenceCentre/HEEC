---
title: "Practice Closures Trigger Analysis"
author: "Cameron Appel"
date: "2024-08-06"
output: 
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Practice Closures Trigger Analysis
```{r}
library(magrittr)
### Satisfaction analysis

### Workforce analysis
wf15 <- read.csv("../../data/workforce/raw/15_9.csv")
wf23 <- read.csv("../../data/workforce/raw/23_9.csv")

pay15 <- read.csv("../../data/payments/raw/14-15.csv")
pay23 <- read.csv("../../data/payments/raw/22-23.csv")

fte_15 <- wf15$TOTAL_GP_EXTGL_FTE %>%
  as.numeric() %>%
  sum(na.rm = TRUE)

fte_23 <- wf23$TOTAL_GP_EXTGL_FTE %>%
  as.numeric() %>%
  sum(na.rm = TRUE)
```

General practice is in crisis: patient satisfaction is at a record low; the number of fully qualified GPs has dropped from `r fte_15` in 2015  to `r fte_23` in 2023 (full-time equivalent, excluding GPs in training and locums).

```{r}
n_prac_15 <- wf15$PRAC_CODE %>%
  unique() %>%
  length()
n_prac_23 <- wf23$PRAC_CODE %>%
  unique() %>%
  length()

n_prac_15_payments <- pay15$Practice.Code %>%
  unique() %>%
  length()

n_prac_23_payments <- pay23$Practice.Code %>%
  unique() %>%
  length()
```
Over the past decade there has been a move towards providing general practice at scale to benefit from economies of scale and to ensure practices are more sustainable. This has led to a dramatic reduction in the number of practices from `r n_prac_15` in 2015 to `r n_prac_23` in 2023, according to the workforce data.

There are some discrepancies with other data sources, however; according to the payments data, the number of practices has dropped from `r n_prac_15_payments` in 2015 to `r n_prac_23_payments` in 2023.

The reasons for and consequences of practice closures are multifaceted. Practices may merge with other practices for purely organisational reasons or because one practice is failing. Mergers may be purely administrative with limited impact on patients, or they may involve closure of premises or redesign of services.

Practices may also close altogether, leaving thousands of patients without access to primary care until they find another surgery. Practice closures are costly in that they incur interruptions in services for patients. One reason for closure is when the partnership model fails within a practice; this partnership model is increasingly under strain because younger doctors are less keen to become a partner due to the financial and workload commitment.

ICBs and NHS England are often unaware of a failing practice until it is too late to intervene. The ability to identify practices or areas of the country which are at risk of failing general practices would help commissioners to intervene where necessary or plan for patient care in the event of a practice closure.

# Closed practice count
The NHS Payments data contains information on practice closures. We can use this data to identify practices that have closed in the past decade.

Where multiple closure dates are available for a practice, we will keep the earliest date.
```{r}
library(dplyr)

closure <- data.frame()

for (file in list.files("../../data/payments/raw/")) {
  df <- read.csv(paste0("../../data/payments/raw/", file))[c("Practice.Code", "Practice.Open.Date", "Practice.Close.Date")]

  # assign year
  year <- substr(file, 1, nchar(file) - 4)
  year <- substr(year, 4, nchar(year))
  year <- paste0("20", year)
  df$Year <- year

  # replace empty values with NA
  df$Practice.Open.Date[df$Practice.Open.Date %in% c("-", "")] <- NA
  df$Practice.Close.Date[df$Practice.Close.Date %in% c("-", "", " ")] <- NA

  # if Practice.Close.Date is not NA, add row to closure dataframe
  closure <- df %>%
    filter(!is.na(Practice.Close.Date)) %>%
    select(Practice.Code, Practice.Close.Date, Year) %>%
    bind_rows(closure)
}

# remove duplicates, keeping lowest value of year
closure <- closure %>%
  group_by(Practice.Code) %>%
  filter(Year == min(Year))

# print number of closed practices per year
closure %>%
  group_by(Year) %>%
  summarise(n = n())
```

# Which practices closed and which just merged?

# Descriptive statistics of closed pratices
To explore the relationship between practice closures and deprivation, we can merge the NHS payments data with the IMD data.

More information on our method used to derive the IMD score can be found [here](https://github.com/camappel/HEEC/tree/main/data/IMD).

```{r IMD}
IMD <- read.csv("../../data/IMD/IMD_interpolated.csv")

# for each year, what is the average and distribution of IMD score?
IMD %>%
  group_by(Year) %>%
  summarise(
    mean_IMD = mean(IMD, na.rm = TRUE),
    sd_IMD = sd(IMD, na.rm = TRUE),
    min_IMD = min(IMD, na.rm = TRUE),
    max_IMD = max(IMD, na.rm = TRUE),
    n = n()
  )

IMD <- IMD %>%
  group_by(Practice.Code) %>%
  filter(Year == max(Year))

# merge IMD with closed by Practice.Code
df_merged <- merge(closure, IMD[-3], by = "Practice.Code", all.x = TRUE)

# how many practices have a missing IMD score?
sum(is.na(df_merged$IMD))

# what is the mean IMD score for closed practices?
df_merged %>%
  group_by(Year) %>%
  summarise(
    mean_IMD = mean(IMD, na.rm = TRUE),
    sd_IMD = sd(IMD, na.rm = TRUE),
    min_IMD = min(IMD, na.rm = TRUE),
    max_IMD = max(IMD, na.rm = TRUE),
    n = n()
  )
```



```{r}
# Remove non-finite values from df_merged
df_clean <- df_merged[!is.na(df_merged$IMD) & is.finite(df_merged$IMD), ]

# Calculate the mean of IMD
mean_IMD <- mean(df_clean$IMD, na.rm = TRUE)

# Create the histogram with a vertical line for the mean
ggplot(df_clean, aes(x = IMD)) +
  geom_histogram(binwidth = 1) +
  geom_vline(aes(xintercept = mean_IMD), color = "red", linetype = "dashed") +
  labs(
    title = "Distribution of IMD scores for closed practices",
    x = "IMD score",
    y = "Frequency"
  )
```

### How do practice closures affect patients?