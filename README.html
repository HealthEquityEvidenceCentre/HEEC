<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Health Equity Evidence Centre</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-01c78b5cd655e4cd89133cf59d535862.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1322888c997fad56b0b4d776d35cf542.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Health Equity Evidence Centre</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./README.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/HealthEquityEvidenceCentre/HEEC"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#datasets" id="toc-datasets" class="nav-link active" data-scroll-target="#datasets">Datasets</a>
  <ul class="collapse">
  <li><a href="#index-of-multiple-deprivation-imd" id="toc-index-of-multiple-deprivation-imd" class="nav-link" data-scroll-target="#index-of-multiple-deprivation-imd">Index of Multiple Deprivation (IMD)</a>
  <ul class="collapse">
  <li><a href="#api" id="toc-api" class="nav-link" data-scroll-target="#api">API</a></li>
  <li><a href="#fingertipsr-package" id="toc-fingertipsr-package" class="nav-link" data-scroll-target="#fingertipsr-package">FingertipsR Package</a></li>
  <li><a href="#direct-download" id="toc-direct-download" class="nav-link" data-scroll-target="#direct-download">Direct download</a></li>
  </ul></li>
  <li><a href="#payments" id="toc-payments" class="nav-link" data-scroll-target="#payments">Payments</a></li>
  <li><a href="#age-group-data" id="toc-age-group-data" class="nav-link" data-scroll-target="#age-group-data">Age Group Data</a></li>
  <li><a href="#satisfaction" id="toc-satisfaction" class="nav-link" data-scroll-target="#satisfaction">Satisfaction</a></li>
  <li><a href="#gp-workforce" id="toc-gp-workforce" class="nav-link" data-scroll-target="#gp-workforce">GP Workforce</a></li>
  <li><a href="#gp-earnings" id="toc-gp-earnings" class="nav-link" data-scroll-target="#gp-earnings">GP Earnings</a></li>
  </ul></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a>
  <ul class="collapse">
  <li><a href="#structural-inequalities-in-primary-care-the-facts-and-figures" id="toc-structural-inequalities-in-primary-care-the-facts-and-figures" class="nav-link" data-scroll-target="#structural-inequalities-in-primary-care-the-facts-and-figures">1. Structural inequalities in primary care – the facts and figures</a></li>
  <li><a href="#nhs-payments-to-practices-in-the-east-of-england" id="toc-nhs-payments-to-practices-in-the-east-of-england" class="nav-link" data-scroll-target="#nhs-payments-to-practices-in-the-east-of-england">2. NHS payments to practices in the East of England</a></li>
  <li><a href="#what-does-the-latest-gp-patient-survey-tell-us-about-socio-economic-inequalities-in-general-practice" id="toc-what-does-the-latest-gp-patient-survey-tell-us-about-socio-economic-inequalities-in-general-practice" class="nav-link" data-scroll-target="#what-does-the-latest-gp-patient-survey-tell-us-about-socio-economic-inequalities-in-general-practice">3. What does the latest GP Patient Survey tell us about socio-economic inequalities in general practice?</a></li>
  <li><a href="#exploring-the-impact-of-dispensing-practices-on-equity-in-nhs-payments-to-general-practices" id="toc-exploring-the-impact-of-dispensing-practices-on-equity-in-nhs-payments-to-general-practices" class="nav-link" data-scroll-target="#exploring-the-impact-of-dispensing-practices-on-equity-in-nhs-payments-to-general-practices">4. Exploring the impact of dispensing practices on equity in NHS payments to general practices</a></li>
  <li><a href="#general-practice-inequalities-datapacks" id="toc-general-practice-inequalities-datapacks" class="nav-link" data-scroll-target="#general-practice-inequalities-datapacks">5. General Practice Inequalities Datapacks</a></li>
  <li><a href="#how-does-the-age-structure-of-patients-affect-nhs-payments-to-general-practice" id="toc-how-does-the-age-structure-of-patients-affect-nhs-payments-to-general-practice" class="nav-link" data-scroll-target="#how-does-the-age-structure-of-patients-affect-nhs-payments-to-general-practice">6. How does the age structure of patients affect NHS payments to General Practice?</a></li>
  <li><a href="#sorry-were-closed-exploring-general-practice-closures" id="toc-sorry-were-closed-exploring-general-practice-closures" class="nav-link" data-scroll-target="#sorry-were-closed-exploring-general-practice-closures">7. Sorry we’re closed: Exploring general practice closures</a></li>
  </ul></li>
  <li><a href="#shiny-applications" id="toc-shiny-applications" class="nav-link" data-scroll-target="#shiny-applications">Shiny Applications</a></li>
  <li><a href="#project-structure" id="toc-project-structure" class="nav-link" data-scroll-target="#project-structure">Project Structure</a>
  <ul class="collapse">
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started">Getting Started</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="README.md"><i class="bi bi-file-code"></i>Github (GFM)</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Health Equity Evidence Centre</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define consistent theme</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>heec_theme <span class="ot">&lt;-</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">color =</span> <span class="st">"gray40"</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Define consistent colors</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>heec_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#1B2C57"</span>, <span class="st">"#00A865"</span>, <span class="st">"#A80026"</span>, <span class="st">"#D35400"</span>, <span class="st">"#8E44AD"</span>, <span class="st">"#3498DB"</span>, <span class="st">"#00A676"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>imd_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"5"</span> <span class="ot">=</span> <span class="st">"#A80026"</span>, <span class="st">"4"</span> <span class="ot">=</span> <span class="st">"#D35400"</span>, <span class="st">"3"</span> <span class="ot">=</span> <span class="st">"#8E44AD"</span>, <span class="st">"2"</span> <span class="ot">=</span> <span class="st">"#3498DB"</span>, <span class="st">"1"</span> <span class="ot">=</span> <span class="st">"#00A676"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>my_colors <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"#1B2C57"</span>, <span class="st">"#00A865"</span>))(<span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This repository serves as a hub for data and analysis related to the Health Equity Evidence Centre project.</p>
<p>Raw and processed data is available in the <a href="data/">data</a> subdirectory. We have complete collated practice-level time-series for the data made available by <a href="https://digital.nhs.uk/">NHS Digital</a>:</p>
<ul>
<li>Index of Multiple Deprivation</li>
<li>NHS Payments to General Practice<br>
</li>
<li>GP Patient Survey</li>
</ul>
<p>RShiny iframes are available in the <a href="shiny/">shiny</a> subdirectory.</p>
<p>Analyses and the relevant code is available in the <a href="analysis/">analysis</a> subdirectory.</p>
<section id="datasets" class="level1">
<h1>Datasets</h1>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Dataset</th>
<th>Description</th>
<th>Source</th>
<th>Time Period</th>
<th>Files</th>
<th>Processing</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>NHS Payments</strong></td>
<td>Practice-level NHS payments to general practice</td>
<td><a href="https://digital.nhs.uk/data-and-information/publications/statistical/nhs-payments-to-general-practice">NHS Digital</a></td>
<td>2015-2023</td>
<td><code>payments/payments.csv</code></td>
<td>Annual files merged with standardized columns</td>
</tr>
<tr class="even">
<td><strong>IMD</strong></td>
<td>Index of Multiple Deprivation at practice level</td>
<td><a href="https://www.gov.uk/government/collections/english-indices-of-deprivation">DoHSC</a></td>
<td>2010, 2015, 2019</td>
<td><code>IMD/IMD_interpolated.csv</code></td>
<td>Interpolated for continuous time series</td>
</tr>
<tr class="odd">
<td><strong>GP Patient Survey</strong></td>
<td>Patient satisfaction and experience metrics</td>
<td><a href="https://www.gp-patient.co.uk/">NHS England</a></td>
<td>2017-2024</td>
<td><code>satisfaction/satisfaction.csv</code></td>
<td>Annual files merged with consistent variables</td>
</tr>
<tr class="even">
<td><strong>GP Workforce</strong></td>
<td>Practice workforce data (GPs, nurses, admin staff)</td>
<td><a href="https://digital.nhs.uk/data-and-information/publications/statistical/general-practice-workforce">NHS Digital</a></td>
<td>2015-2025</td>
<td><code>workforce/workforce_year.csv</code></td>
<td>Monthly data aggregated to annual</td>
</tr>
<tr class="odd">
<td><strong>Age Groups</strong></td>
<td>Proportion of registered patients by age group</td>
<td><a href="https://fingertips.phe.org.uk/">OHID Fingertips</a></td>
<td>2016-2023</td>
<td><code>age_group/age.csv</code></td>
<td>API data focused on 65+ population</td>
</tr>
<tr class="even">
<td><strong>Appointments</strong></td>
<td>Appointment data by mode and status</td>
<td><a href="https://digital.nhs.uk/data-and-information/publications/statistical/appointments-in-general-practice">NHS Digital</a></td>
<td>2024-2025</td>
<td><code>appointments/appointments.csv</code></td>
<td>Monthly practice-level data</td>
</tr>
<tr class="odd">
<td><strong>Disease Prevalence</strong></td>
<td>QOF disease prevalence rates</td>
<td><a href="https://fingertips.phe.org.uk/">OHID Fingertips</a></td>
<td>2023</td>
<td><code>prevalence/ltc_prevalence.csv</code></td>
<td>Long-term condition prevalence</td>
</tr>
<tr class="even">
<td><strong>QOF Achievement</strong></td>
<td>Quality and Outcomes Framework performance</td>
<td><a href="https://digital.nhs.uk/data-and-information/publications/statistical/quality-and-outcomes-framework-achievement-prevalence-and-exceptions-data">NHS Digital</a></td>
<td>2023-2024</td>
<td><code>QOF/qof.csv</code></td>
<td>Achievement and prevalence metrics</td>
</tr>
<tr class="odd">
<td><strong>Health Behaviours</strong></td>
<td>Smoking, obesity, hypertension prevalence</td>
<td><a href="https://fingertips.phe.org.uk/">OHID Fingertips</a></td>
<td>2023</td>
<td><code>behaviours/behaviours.csv</code></td>
<td>Risk factor prevalence</td>
</tr>
<tr class="even">
<td><strong>Secondary Care</strong></td>
<td>Emergency admissions and A&amp;E attendances</td>
<td><a href="https://fingertips.phe.org.uk/">OHID Fingertips</a></td>
<td>2023</td>
<td><code>secondary_care/secondary_care.csv</code></td>
<td>Practice-attributed hospital activity</td>
</tr>
<tr class="odd">
<td><strong>Life Expectancy</strong></td>
<td>Life expectancy by practice population</td>
<td><a href="https://fingertips.phe.org.uk/">OHID Fingertips</a></td>
<td>2018-2020</td>
<td><code>life_expectancy/life_expectancy.csv</code></td>
<td>Practice-level life expectancy estimates</td>
</tr>
<tr class="even">
<td><strong>PCN Workforce</strong></td>
<td>Primary Care Network workforce data</td>
<td><a href="https://digital.nhs.uk/data-and-information/publications/statistical/general-practice-workforce">NHS Digital</a></td>
<td>2020-2024</td>
<td><code>pcn_workforce/pcn_workforce.csv</code></td>
<td>Additional roles and PCN staff</td>
</tr>
<tr class="odd">
<td><strong>GP Earnings</strong></td>
<td>GP partner and salaried income data</td>
<td><a href="https://digital.nhs.uk/data-and-information/publications/statistical/gp-earnings-and-expenses-estimates">NHS Digital</a></td>
<td>2018-2023</td>
<td><code>GP_earnings/</code></td>
<td>Partner income and practice expenses</td>
</tr>
<tr class="even">
<td><strong>CQC Ratings</strong></td>
<td>Care Quality Commission inspection ratings</td>
<td><a href="https://www.cqc.org.uk/about-us/transparency/using-cqc-data">CQC</a></td>
<td>2024</td>
<td><code>CQC/cqc.csv</code></td>
<td>Practice quality ratings</td>
</tr>
<tr class="odd">
<td><strong>CCG/ICB Codes</strong></td>
<td>Mapping between CCG and ICB codes</td>
<td>NHS England</td>
<td>2023</td>
<td><code>CCG_ICB_code.csv</code></td>
<td>Geographic area mappings</td>
</tr>
</tbody>
</table>
<section id="index-of-multiple-deprivation-imd" class="level2">
<h2 class="anchored" data-anchor-id="index-of-multiple-deprivation-imd">Index of Multiple Deprivation (IMD)</h2>
<p>The Ministry of Housing, Communities and Local Government calculates the English Indices of Deprivation, which includes the Index of Multiple Deprivation (IMD) - the official measure of relative deprivation in England - at the practice-level. This data is used to assess the socio-economic status of the population served by each practice.</p>
<p>The latest release is IoD2019; no new release has been announced as of Nov 2024.</p>
<section id="api" class="level3">
<h3 class="anchored" data-anchor-id="api">API</h3>
<p>This data can be accessed through the <a href="https://fingertips.phe.org.uk/api">API</a> provided by the Fingertips platform.</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL and query parameters</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://fingertipsws.phe.org.uk/api/all_data/csv/by_indicator_id"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>query_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">v =</span> <span class="st">"/0-c459298b/"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">parent_area_code =</span> <span class="st">"E92000001"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">parent_area_type_id =</span> <span class="dv">167</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">child_area_type_id =</span> <span class="dv">7</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">indicator_ids =</span> <span class="dv">93553</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the API request</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="fu">GET</span>(base_url, <span class="at">query =</span> query_params)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the response is successful</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">http_status</span>(response)<span class="sc">$</span>category <span class="sc">==</span> <span class="st">"Success"</span>) {</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Write the content to a temporary file</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  temp_file <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".csv"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeBin</span>(<span class="fu">content</span>(response, <span class="st">"raw"</span>), temp_file)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the CSV data</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  IMD <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(temp_file)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Display the first few rows of the data</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(IMD))</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Failed to retrieve data. Status code:"</span>, <span class="fu">status_code</span>(response), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Response content:"</span>, <span class="fu">content</span>(response, <span class="st">"text"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 27
  `Indicator ID` `Indicator Name`        `Parent Code` `Parent Name` `Area Code`
           &lt;dbl&gt; &lt;chr&gt;                   &lt;chr&gt;         &lt;chr&gt;         &lt;chr&gt;      
1          93553 Deprivation score (IMD… &lt;NA&gt;          &lt;NA&gt;          E92000001  
2          93553 Deprivation score (IMD… E92000001     England       E38000217  
3          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81001     
4          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81002     
5          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81004     
6          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81005     
# ℹ 22 more variables: `Area Name` &lt;chr&gt;, `Area Type` &lt;chr&gt;, Sex &lt;chr&gt;,
#   Age &lt;chr&gt;, `Category Type` &lt;chr&gt;, Category &lt;chr&gt;, `Time period` &lt;dbl&gt;,
#   Value &lt;dbl&gt;, `Lower CI 95.0 limit` &lt;lgl&gt;, `Upper CI 95.0 limit` &lt;lgl&gt;,
#   `Lower CI 99.8 limit` &lt;lgl&gt;, `Upper CI 99.8 limit` &lt;lgl&gt;, Count &lt;lgl&gt;,
#   Denominator &lt;lgl&gt;, `Value note` &lt;chr&gt;, `Recent Trend` &lt;chr&gt;,
#   `Compared to England value or percentiles` &lt;chr&gt;,
#   `Compared to CCGs (from Apr 2021) value or percentiles` &lt;chr&gt;, …</code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(IMD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 27
  `Indicator ID` `Indicator Name`        `Parent Code` `Parent Name` `Area Code`
           &lt;dbl&gt; &lt;chr&gt;                   &lt;chr&gt;         &lt;chr&gt;         &lt;chr&gt;      
1          93553 Deprivation score (IMD… &lt;NA&gt;          &lt;NA&gt;          E92000001  
2          93553 Deprivation score (IMD… E92000001     England       E38000217  
3          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81001     
4          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81002     
5          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81004     
6          93553 Deprivation score (IMD… E38000247     NHS Tees Val… A81005     
# ℹ 22 more variables: `Area Name` &lt;chr&gt;, `Area Type` &lt;chr&gt;, Sex &lt;chr&gt;,
#   Age &lt;chr&gt;, `Category Type` &lt;chr&gt;, Category &lt;chr&gt;, `Time period` &lt;dbl&gt;,
#   Value &lt;dbl&gt;, `Lower CI 95.0 limit` &lt;lgl&gt;, `Upper CI 95.0 limit` &lt;lgl&gt;,
#   `Lower CI 99.8 limit` &lt;lgl&gt;, `Upper CI 99.8 limit` &lt;lgl&gt;, Count &lt;lgl&gt;,
#   Denominator &lt;lgl&gt;, `Value note` &lt;chr&gt;, `Recent Trend` &lt;chr&gt;,
#   `Compared to England value or percentiles` &lt;chr&gt;,
#   `Compared to CCGs (from Apr 2021) value or percentiles` &lt;chr&gt;, …</code></pre>
</div>
</div>
</section>
<section id="fingertipsr-package" class="level3">
<h3 class="anchored" data-anchor-id="fingertipsr-package">FingertipsR Package</h3>
<p>The IMD data can also be accessed using the <code>fingertipsR</code> <a href="https://github.com/ropensci/fingertipsR">package</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary library</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fingertipsR)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the profile ID for the Public Health Outcomes Framework</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>profiles_data <span class="ot">&lt;-</span> <span class="fu">profiles</span>()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>phof_profile <span class="ot">&lt;-</span> profiles_data[profiles_data<span class="sc">$</span>ProfileName <span class="sc">==</span> <span class="st">"Public Health Outcomes Framework"</span>, ]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>profile_id <span class="ot">&lt;-</span> phof_profile<span class="sc">$</span>ProfileID[<span class="dv">1</span>]</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the profile details (optional)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(phof_profile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  ProfileID ProfileName                        DomainID DomainName              
      &lt;int&gt; &lt;chr&gt;                                 &lt;int&gt; &lt;chr&gt;                   
1        19 Public Health Outcomes Framework    1000049 A. Overarching indicato…
2        19 Public Health Outcomes Framework    1000041 B. Wider determinants o…
3        19 Public Health Outcomes Framework    1000042 C. Health improvement   
4        19 Public Health Outcomes Framework    1000043 D. Health protection    
5        19 Public Health Outcomes Framework    1000044 E. Healthcare and prema…
6        19 Public Health Outcomes Framework 1938132983 Supporting information  </code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get indicators for the Public Health Outcomes Framework profile</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>indicators_data <span class="ot">&lt;-</span> <span class="fu">indicators</span>(<span class="at">ProfileID =</span> profile_id)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the IndicatorID for "Deprivation score (IMD 2019)"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>indicator_id <span class="ot">&lt;-</span> indicators_data<span class="sc">$</span>IndicatorID[indicators_data<span class="sc">$</span>IndicatorName <span class="sc">==</span> <span class="st">"Deprivation score (IMD 2019)"</span>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the indicator details (optional)</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(indicators_data[indicators_data<span class="sc">$</span>IndicatorName <span class="sc">==</span> <span class="st">"Deprivation score (IMD 2019)"</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  IndicatorID IndicatorName            DomainID DomainName ProfileID ProfileName
        &lt;int&gt; &lt;fct&gt;                       &lt;int&gt; &lt;chr&gt;          &lt;int&gt; &lt;chr&gt;      
1       93553 Deprivation score (IMD …   1.94e9 Supportin…        19 Public Hea…</code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the data for the "Deprivation score (IMD 2019)" indicator</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>IMD <span class="ot">&lt;-</span> <span class="fu">fingertips_data</span>(<span class="at">IndicatorID =</span> indicator_id, <span class="at">AreaTypeID =</span> <span class="dv">7</span>) <span class="co"># AreaTypeID 7 is for CCGs</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the data</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(IMD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  IndicatorID                IndicatorName ParentCode                ParentName
1       93553 Deprivation score (IMD 2019)       &lt;NA&gt;                      &lt;NA&gt;
2       93553 Deprivation score (IMD 2019)     U89141              Stockton PCN
3       93553 Deprivation score (IMD 2019)     U07032        North Stockton PCN
4       93553 Deprivation score (IMD 2019)     U02671 Greater Middlesbrough PCN
5       93553 Deprivation score (IMD 2019)     U07842        East Cleveland PCN
6       93553 Deprivation score (IMD 2019)     U07032        North Stockton PCN
   AreaCode                        AreaName AreaType     Sex      Age
1 E92000001                         England  England Persons All ages
2    A81001             The Densham Surgery      GPs Persons All ages
3    A81002      Queens Park Medical Centre      GPs Persons All ages
4    A81004           Acklam Medical Centre      GPs Persons All ages
5    A81005              Springwood Surgery      GPs Persons All ages
6    A81006 Tennant Street Medical Practice      GPs Persons All ages
  CategoryType Category Timeperiod    Value LowerCI95.0limit UpperCI95.0limit
1         &lt;NA&gt;     &lt;NA&gt;       2010 21.69383               NA               NA
2         &lt;NA&gt;     &lt;NA&gt;       2010 25.07512               NA               NA
3         &lt;NA&gt;     &lt;NA&gt;       2010 27.70068               NA               NA
4         &lt;NA&gt;     &lt;NA&gt;       2010 33.05193               NA               NA
5         &lt;NA&gt;     &lt;NA&gt;       2010 14.55969               NA               NA
6         &lt;NA&gt;     &lt;NA&gt;       2010 29.14449               NA               NA
  LowerCI99.8limit UpperCI99.8limit Count Denominator Valuenote RecentTrend
1               NA               NA    NA          NA      &lt;NA&gt;        &lt;NA&gt;
2               NA               NA    NA          NA      &lt;NA&gt;        &lt;NA&gt;
3               NA               NA    NA          NA      &lt;NA&gt;        &lt;NA&gt;
4               NA               NA    NA          NA      &lt;NA&gt;        &lt;NA&gt;
5               NA               NA    NA          NA      &lt;NA&gt;        &lt;NA&gt;
6               NA               NA    NA          NA      &lt;NA&gt;        &lt;NA&gt;
  ComparedtoEnglandvalueorpercentiles
1                        Not compared
2                        Not compared
3                        Not compared
4                        Not compared
5                        Not compared
6                        Not compared
  ComparedtoPCNs(v.25/10/24)valueorpercentiles TimeperiodSortable Newdata
1                                 Not compared           20100000    &lt;NA&gt;
2                                 Not compared           20100000    &lt;NA&gt;
3                                 Not compared           20100000    &lt;NA&gt;
4                                 Not compared           20100000    &lt;NA&gt;
5                                 Not compared           20100000    &lt;NA&gt;
6                                 Not compared           20100000    &lt;NA&gt;
  Comparedtogoal Timeperiodrange
1           &lt;NA&gt;              1y
2           &lt;NA&gt;              1y
3           &lt;NA&gt;              1y
4           &lt;NA&gt;              1y
5           &lt;NA&gt;              1y
6           &lt;NA&gt;              1y</code></pre>
</div>
</div>
</section>
<section id="direct-download" class="level3">
<h3 class="anchored" data-anchor-id="direct-download">Direct download</h3>
<p>However, this data only provides values for practices that are still active in 2019. To get the data for all practices, we obtained the CSV directly from OHID via email, which is available <a href="https://github.com/camappel/HEEC/blob/main/data/IMD/IMD_raw.csv">here</a> as <code>IMD_raw.csv</code>.</p>
<p>IMD values are only provided for 2010, 2015, and 2019. In order to have a continuous time series, we interpolate the values between these years, and extrapolate the values for 2020-2025. The resultant data is saved <a href="https://github.com/camappel/HEEC/blob/main/data/IMD/IMD_interpolated.csv">here</a> as <code>IMD_interpolated.csv</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>IMD <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/IMD/IMD_raw.csv"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>IMD <span class="ot">&lt;-</span> IMD[, <span class="fu">c</span>(<span class="st">"AreaCode"</span>, <span class="st">"Value"</span>, <span class="st">"Year"</span>)]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>IMD <span class="sc">%&lt;&gt;%</span> <span class="fu">rename</span>(., <span class="at">Practice.Code =</span> AreaCode)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>IMD <span class="sc">%&lt;&gt;%</span> <span class="fu">rename</span>(., <span class="at">IMD =</span> Value)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="do">### interpolate IMD</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>result_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(IMD<span class="sc">$</span>Practice.Code)) {</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  has_2010 <span class="ot">&lt;-</span> <span class="fu">any</span>(IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i <span class="sc">&amp;</span> IMD<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2010</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  has_2015 <span class="ot">&lt;-</span> <span class="fu">any</span>(IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i <span class="sc">&amp;</span> IMD<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2015</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  has_2019 <span class="ot">&lt;-</span> <span class="fu">any</span>(IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i <span class="sc">&amp;</span> IMD<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2019</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if data is only available for 2010, extrapolate to 2011-2025</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (has_2010 <span class="sc">&amp;</span> <span class="sc">!</span>has_2015) {</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2011</span><span class="sc">:</span><span class="dv">2025</span>) {</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">Year =</span> year,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">Practice.Code =</span> i,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">IMD =</span> IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i <span class="sc">&amp;</span> IMD<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2010</span>, ]<span class="sc">$</span>IMD</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Append the new row to the result data frame</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      result_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(result_df, new_row)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if data is available for 2010 and 2015, interpolate to 2011-2014</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (has_2010 <span class="sc">&amp;</span> has_2015) {</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2011</span><span class="sc">:</span><span class="dv">2014</span>) {</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>      y_new <span class="ot">&lt;-</span> <span class="fu">approx</span>(</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i, ]<span class="sc">$</span>Year,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>        IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i, ]<span class="sc">$</span>IMD,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">xout =</span> year</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a new row for the current year and AreaCode</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">Year =</span> year,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">Practice.Code =</span> i,</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">IMD =</span> y_new<span class="sc">$</span>y</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Append the new row to the result data frame</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>      result_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(result_df, new_row)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if data is available for 2015 but not 2019, extrapolate to 2016-2025</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (has_2015 <span class="sc">&amp;</span> <span class="sc">!</span>has_2019) {</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2016</span><span class="sc">:</span><span class="dv">2025</span>) {</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">Year =</span> year,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">Practice.Code =</span> i,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">IMD =</span> IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i <span class="sc">&amp;</span> IMD<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2015</span>, ]<span class="sc">$</span>IMD</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Append the new row to the result data frame</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>      result_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(result_df, new_row)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if data is available for 2015 and 2019, interpolate to 2016-2018</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (has_2015 <span class="sc">&amp;</span> has_2019) {</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2016</span><span class="sc">:</span><span class="dv">2018</span>) {</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>      y_new <span class="ot">&lt;-</span> <span class="fu">approx</span>(</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i, ]<span class="sc">$</span>Year,</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i, ]<span class="sc">$</span>IMD,</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">xout =</span> year</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Create a new row for the current year and AreaCode</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">Year =</span> year,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">Practice.Code =</span> i,</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">IMD =</span> y_new<span class="sc">$</span>y</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Append the new row to the result data frame</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>      result_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(result_df, new_row)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if data is available for 2019, extrapolate to 2020-2025</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (has_2019) {</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2020</span><span class="sc">:</span><span class="dv">2025</span>) {</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>      new_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">Year =</span> year,</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">Practice.Code =</span> i,</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">IMD =</span> IMD[IMD<span class="sc">$</span>Practice.Code <span class="sc">==</span> i <span class="sc">&amp;</span> IMD<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2019</span>, ]<span class="sc">$</span>IMD</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Append the new row to the result data frame</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>      result_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(result_df, new_row)</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>IMD <span class="ot">&lt;-</span> <span class="fu">rbind</span>(IMD, result_df)</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>IMD <span class="ot">&lt;-</span> IMD[<span class="fu">order</span>(IMD<span class="sc">$</span>Practice.Code, IMD<span class="sc">$</span>Year), ]</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>IMD <span class="sc">%&gt;%</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_IMD =</span> <span class="fu">mean</span>(IMD, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_IMD =</span> <span class="fu">sd</span>(IMD, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_IMD =</span> <span class="fu">min</span>(IMD, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_IMD =</span> <span class="fu">max</span>(IMD, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">n</span>()</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 16 × 6
    Year mean_IMD sd_IMD min_IMD max_IMD     n
   &lt;int&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt;
 1  2010     24.2   12.8    2.60    68.9  8222
 2  2011     24.2   12.6    2.77    68.4  8222
 3  2012     24.1   12.4    2.95    67.9  8222
 4  2013     24.1   12.2    3.13    67.4  8222
 5  2014     24.1   12.1    3.31    67.0  8222
 6  2015     24.1   12.0    3.21    66.5  8438
 7  2016     24.1   11.9    3.21    66.5  8438
 8  2017     24.1   11.9    3.21    67.1  8438
 9  2018     24.1   11.9    3.21    67.9  8438
10  2019     24.1   11.9    3.21    68.7  8461
11  2020     24.1   11.9    3.21    68.7  8461
12  2021     24.1   11.9    3.21    68.7  8461
13  2022     24.1   11.9    3.21    68.7  8461
14  2023     24.1   11.9    3.21    68.7  8461
15  2024     24.1   11.9    3.21    68.7  8461
16  2025     24.1   11.9    3.21    68.7  8461</code></pre>
</div>
</div>
</section>
</section>
<section id="payments" class="level2">
<h2 class="anchored" data-anchor-id="payments">Payments</h2>
<p>NHS Digital provided annual data on payments made to general practices in England from 2014/15 to 22/23.</p>
<p>Annual practice level .csv files are available <a href="https://digital.nhs.uk/data-and-information/publications/statistical/nhs-payments-to-general-practice">here</a>; some preprocessing has been done to clean the data and ensure consistency in variable names across years.</p>
<p>Execute the following code to merge the data to create a single time-series dataset:</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> <span class="fu">list.files</span>(<span class="st">"data/payments/raw"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>]) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">paste0</span>(<span class="st">"data/payments/raw/"</span>, file))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign year</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Year <span class="ot">&lt;-</span> file <span class="sc">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">substr</span>(<span class="dv">1</span>, <span class="fu">nchar</span>(.) <span class="sc">-</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">substr</span>(<span class="dv">4</span>, <span class="fu">nchar</span>(.)) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">"20"</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Average.payments.per.registered.patient <span class="sc">%&lt;&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Average.payments.per.weighted.patient <span class="sc">%&lt;&gt;%</span> <span class="fu">as.numeric</span>()</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  nhs_payments <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(nhs_payments, df)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add 2021 with COVID + PCN (incl deductions)</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes Total.NHS.Payments.to.General.Practice, Total.NHS.Payments.including.covid.vaccination.and.covid.support.and.expansion.payments, and Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Total.NHS.Payments should include PCN and COVID payments</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>payments2021 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/payments/raw/20-21.csv"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>payments2021<span class="sc">$</span>Year <span class="ot">&lt;-</span> <span class="dv">2021</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>payments2021<span class="sc">$</span>Total.COVID.Payments <span class="ot">&lt;-</span> payments2021<span class="sc">$</span>Total.NHS.Payments.including.covid.vaccination.and.covid.support.and.expansion.payments <span class="sc">-</span> payments2021<span class="sc">$</span>Total.NHS.Payments.to.General.Practice</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>payments2021<span class="sc">$</span>Total.PCN.Payments <span class="ot">&lt;-</span> payments2021<span class="sc">$</span>Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support <span class="sc">-</span> payments2021<span class="sc">$</span>Total.NHS.Payments.to.General.Practice</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>payments2021<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="ot">&lt;-</span> payments2021<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="sc">+</span> payments2021<span class="sc">$</span>Total.COVID.Payments <span class="sc">+</span> payments2021<span class="sc">$</span>Total.PCN.Payments</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>payments2021<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.Minus.Deductions <span class="ot">&lt;-</span> payments2021<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="sc">-</span> payments2021<span class="sc">$</span>Deductions.for.Pensions..Levies.and.Prescription.Charge.Income</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add 2022 with COVID + PCN</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments as well as Total.NHS.Payments.to.General.Practice</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>payments2022 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/payments/raw/21-22.csv"</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>payments2022<span class="sc">$</span>Year <span class="ot">&lt;-</span> <span class="dv">2022</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>payments2022<span class="sc">$</span>Total.COVID.Payments <span class="ot">&lt;-</span> payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.including.covid.vaccination..covid.support.and.long.covid.payments <span class="sc">-</span> payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>payments2022<span class="sc">$</span>Total.PCN.Payments <span class="ot">&lt;-</span> payments2022<span class="sc">$</span>Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support <span class="sc">-</span> payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="ot">&lt;-</span> payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.Minus.Deductions <span class="ot">&lt;-</span> payments2022<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="sc">-</span> payments2022<span class="sc">$</span>Deductions.for.Pensions..Levies.and.Prescription.Charge.Income</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Add 2023</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Includes Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments as well as Total.NHS.Payments.to.General.Practice</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>payments2023 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/payments/raw/22-23.csv"</span>)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>payments2023<span class="sc">$</span>Year <span class="ot">&lt;-</span> <span class="dv">2023</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>payments2023<span class="sc">$</span>Total.COVID.Payments <span class="ot">&lt;-</span> payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.including.covid.vaccination..covid.support.and.long.covid.payments <span class="sc">-</span> payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>payments2023<span class="sc">$</span>Total.PCN.Payments <span class="ot">&lt;-</span> payments2023<span class="sc">$</span>Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support <span class="sc">-</span> payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="ot">&lt;-</span> payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice.Minus.Deductions <span class="ot">&lt;-</span> payments2023<span class="sc">$</span>Total.NHS.Payments.to.General.Practice <span class="sc">-</span> payments2023<span class="sc">$</span>Deductions.for.Pensions..Levies.and.Prescription.Charge.Income</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(nhs_payments, payments2021, payments2022, payments2023)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_payments =</span> <span class="fu">sum</span>(Total.NHS.Payments.to.General.Practice),</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_patients =</span> <span class="fu">sum</span>(Number.of.Registered.Patients..Last.Known.Figure.),</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_practices =</span> <span class="fu">n</span>()</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
   Year total_payments total_patients n_practices
  &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;       &lt;int&gt;
1  2015    7990324226       56633982         7959
2  2016    8182561838.      57371518         7841
3  2017    8883780328.      58688866         7763
4  2018    9050596202.      59527981         7543
5  2019    9261391490.      59824330.        7279
6  2020    9377079859.      60316398.        7001
7  2021   10309607071.      60671585.        6808
8  2022   11510115126.      61570004.        6758
9  2023   11011986630.      62134645.        6669</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>CCG_ICB <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/CCG_ICB_code.csv"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># match CCG.Code in df with CCG.Code in ccg_icb and return ICB.Name</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>ICB.NAME <span class="ot">&lt;-</span> CCG_ICB[<span class="fu">match</span>(nhs_payments<span class="sc">$</span>CCG.Code, CCG_ICB<span class="sc">$</span>CCG.Code), ]<span class="sc">$</span>ICB.NAME</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># In nhs_payments$ICB.NAME, remove "NHS " from the beginning of each string and " Integrated Care Board" from the end of each string</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="ot">&lt;-</span> nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ICB.NAME =</span> ICB.NAME <span class="sc">%&gt;%</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gsub</span>(<span class="st">"^NHS "</span>, <span class="st">""</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gsub</span>(<span class="st">" Integrated Care Board$"</span>, <span class="st">""</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gsub</span>(<span class="st">" ICB"</span>, <span class="st">""</span>, .))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>ICB.NAME <span class="sc">%&gt;%</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Bath and North East Somerset, Swindon and Wiltshire"
 [2] "Bedfordshire, Luton and Milton Keynes"              
 [3] "Birmingham and Solihull"                            
 [4] "Black Country"                                      
 [5] "Bristol, North Somerset and South Gloucestershire"  
 [6] "Buckinghamshire, Oxfordshire and Berkshire West"    
 [7] "Cambridgeshire and Peterborough"                    
 [8] "Cheshire and Merseyside"                            
 [9] "Cornwall and the Isles of Scilly"                   
[10] "Coventry and Warwickshire"                          
[11] "Derby and Derbyshire"                               
[12] "Devon"                                              
[13] "Dorset"                                             
[14] "Frimley"                                            
[15] "Gloucestershire"                                    
[16] "Greater Manchester"                                 
[17] "Hampshire and Isle of Wight"                        
[18] "Herefordshire and Worcestershire"                   
[19] "Hertfordshire and West Essex"                       
[20] "Humber and North Yorkshire"                         
[21] "Kent and Medway"                                    
[22] "Lancashire and South Cumbria"                       
[23] "Leicester, Leicestershire and Rutland"              
[24] "Lincolnshire"                                       
[25] "Mid and South Essex"                                
[26] "Norfolk and Waveney"                                
[27] "North Central London"                               
[28] "North East and North Cumbria"                       
[29] "North East London"                                  
[30] "North West London"                                  
[31] "Northamptonshire"                                   
[32] "Nottingham and Nottinghamshire"                     
[33] "Shropshire, Telford and Wrekin"                     
[34] "Somerset"                                           
[35] "South East London"                                  
[36] "South West London"                                  
[37] "South Yorkshire"                                    
[38] "Staffordshire and Stoke-on-Trent"                   
[39] "Suffolk and North East Essex"                       
[40] "Surrey Heartlands"                                  
[41] "Sussex"                                             
[42] "West Yorkshire"                                     </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>standardise_columns <span class="ot">&lt;-</span> <span class="cf">function</span>(nhs_payments) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper function to merge columns and keep the first non-NA value</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  merge_columns <span class="ot">&lt;-</span> <span class="cf">function</span>(df, cols, new_col) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    df[[new_col]] <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="fu">all_of</span>(cols)) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">apply</span>(<span class="dv">1</span>, <span class="cf">function</span>(x) {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        x <span class="ot">&lt;-</span> x[<span class="sc">!</span><span class="fu">is.na</span>(x)]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>          <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(x[<span class="dv">1</span>])</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>      }) <span class="sc">%&gt;%</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.character</span>()</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop the original columns but keep the new column</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(cols), <span class="fu">all_of</span>(new_col))</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge "PracticeType", "Practice.Type", "Practice.type" into one column called Practice.Type</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  nhs_payments <span class="ot">&lt;-</span> <span class="fu">merge_columns</span>(nhs_payments, <span class="fu">c</span>(<span class="st">"PracticeType"</span>, <span class="st">"Practice.Type"</span>, <span class="st">"Practice.type"</span>), <span class="st">"Practice.Type"</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge "PracticeRurality", "Practice.Rurality" into one column called Practice.Rurality</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  nhs_payments <span class="ot">&lt;-</span> <span class="fu">merge_columns</span>(nhs_payments, <span class="fu">c</span>(<span class="st">"PracticeRurality"</span>, <span class="st">"Practice.Rurality"</span>), <span class="st">"Practice.Rurality"</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge "AtypicalCharacteristics", "Atypical.Characteristics", "Atypical.characteristics" into one column called Atypical.Characteristics</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  nhs_payments <span class="ot">&lt;-</span> <span class="fu">merge_columns</span>(nhs_payments, <span class="fu">c</span>(<span class="st">"AtypicalCharacteristics"</span>, <span class="st">"Atypical.Characteristics"</span>, <span class="st">"Atypical.characteristics"</span>), <span class="st">"Atypical.Characteristics"</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge "Code" into "PCN.Code"</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  nhs_payments <span class="ot">&lt;-</span> <span class="fu">merge_columns</span>(nhs_payments, <span class="fu">c</span>(<span class="st">"PCN.Code"</span>, <span class="st">"Code"</span>), <span class="st">"PCN.Code"</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(nhs_payments)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="ot">&lt;-</span> <span class="fu">standardise_columns</span>(nhs_payments)</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co"># drop Total.NHS.Payments.including.covid.vaccination.and.covid.support.and.expansion.payments, Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support, Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments, Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments.minus.deductions, Total.NHS.Payments.to.General.Practice.including.covid.vaccination..covid.support.and.long.covid.payments</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="ot">&lt;-</span> nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Total.NHS.Payments.including.covid.vaccination.and.covid.support.and.expansion.payments, <span class="sc">-</span>Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support, <span class="sc">-</span>Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments, <span class="sc">-</span>Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments.minus.deductions, <span class="sc">-</span>Total.NHS.Payments.to.General.Practice.including.covid.vaccination..covid.support.and.long.covid.payments)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="co"># The following lists should contain all columns in NHS payments</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>practice_information <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NHS.England..Region..code"</span>, <span class="st">"NHS.England..Region..Name"</span>,</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"CCG.Code"</span>, <span class="st">"CCG.NAME"</span>,</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Practice.Code"</span>, <span class="st">"Practice.Name"</span>,</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Practice.Address"</span>, <span class="st">"Practice.Postcode"</span>,</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Practice.Open.Date"</span>, <span class="st">"Practice.Close.Date"</span>,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Contract.Type"</span>, <span class="st">"Dispensing.Practice"</span>,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quarter.used.for.patient.data"</span>,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PracticeType = 2017, Practice.Type = 2018:2021, Practice.type = 2022:2023, None = 2015:2016</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "PracticeType", "Practice.type",</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Practice.Type"</span>,</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PracticeRurality = 2017, Practice.Rurality = 2018:2023, None = 2015:2016</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">#  "PracticeRurality",</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Practice.Rurality"</span>,</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># AtypicalCharacteristics = 2017, Atypical.Characteristics = 2018:2020, Atypical.characteristics: 2021:2023, None = 2015:2016</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "AtypicalCharacteristics", "Atypical.characteristics",</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Atypical.Characteristics"</span>,</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Code = 2023</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Code",</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCN.Code"</span>,</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCN.Name"</span>,</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ICB.NAME"</span>, <span class="st">"Sub.ICB.NAME"</span>,</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Year"</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>population_information <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Number.of.Registered.Patients..Last.Known.Figure."</span>,</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Number.of.Weighted.Patients..Last.Known.Figure."</span>,</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.registered.patient"</span>,</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.weighted.patient"</span>,</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.registered.patient.including.PCN.Workforce..Leadership.and.Support"</span>,</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.weighted.patient.including.PCN.Workforce..Leadership.and.Support"</span>,</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.registered.patient.including.covid.vaccination.and.covid.support.and.expansion.payments"</span>,</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.weighted.patient.including.covid.vaccination.and.covid.support.and.expansion.payments"</span>,</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.registered.patient.including.covid.vaccination..covid.support.and.long.covid.payments"</span>,</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Average.payments.per.weighted.patient.including.covid.vaccination..covid.support.and.long.covid.payments"</span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>totals <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total.NHS.Payments.to.General.Practice"</span>,</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments" is now Total.NHS.Payments.to.General.Practice</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Total.NHS.Payments.including.covid.vaccination.and.covid.support.and.expansion.payments = 2021, Total.NHS.Payments.to.General.Practice.including.covid.vaccination..covid.support.and.long.covid.payments = 2022:2023</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Total.NHS.Payments.to.General.Practice.including.covid.vaccination..covid.support.and.long.covid.payments",</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Total.NHS.Payments.including.covid.vaccination.and.covid.support.and.expansion.payments",</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Total.NHS.Payments.including.PCN.Workforce..Leadership.and.Support",</span></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Deductions.for.Pensions..Levies.and.Prescription.Charge.Income"</span>,</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total.NHS.Payments.to.General.Practice.Minus.Deductions"</span>,</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Total.NHS.Payments.to.General.Practice.including.Covid.and.PCN.payments.minus.deductions",</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total.COVID.Payments"</span>, <span class="st">"Total.PCN.Payments"</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>globalSum <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2015</span></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Global.Sum"</span>, <span class="st">"MPIG.Correction.factor"</span>, <span class="st">"Balance.of.PMS.Expenditure"</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>ITPremises <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2015</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Premises.Payments"</span>, <span class="st">"Information.Management.and.Technology"</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Seniority payments were made to principal GPs in recognition of their years of NHS reckonable service.</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="co"># The scheme closed to new applicants on the 1 April, 2014 and the last payments were made at the end of March 2020.</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>PCO <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2015</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Seniority"</span>, <span class="st">"Doctors.Retainer.Scheme.Payments"</span>, <span class="st">"Total.Locum.Allowances"</span>,</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Appraisal.Costs"</span>,</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCO.Admin.Other"</span>, <span class="st">"Other.Payments"</span>,</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>  <span class="st">"General.Practice.Forward.View"</span>,</span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>  <span class="st">"General.Practice.Transformation"</span>, <span class="st">"winter.Access.Fund"</span>,</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Prolonged.Study.Leave"</span>,</span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Appraisal...Appraiser.Costs.in.Respect.of.Locums"</span>,</span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCN.Participation"</span>, <span class="st">"PCN.Leadership"</span>, <span class="st">"PCN.Support"</span>,</span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCN.Extended.Hours.Access"</span>, <span class="st">"PCN.Workforce"</span>,</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCN.Investment.and.impact.Fund"</span>,</span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>  <span class="st">"PCN.Care.Home.Premium"</span>, <span class="st">"PCN.Enhanced.Access"</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>QOF <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Total.QOF.Payments"</span>)</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>contractedServices <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Alcohol"</span>, <span class="st">"Childhood.Vaccination.and.Immunisation.Scheme"</span>,</span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GP.Extended.Hours.Access"</span>,</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Facilitating.Timely.Diagnosis.and.Support.for.People.with.Dementia"</span>,</span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Improving.Patient.Online.Access"</span>,</span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Influenza.and.Pneumococcal.Immunisations"</span>, <span class="st">"Learning.Disabilities"</span>,</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Minor.Surgery"</span>, <span class="st">"Patient.Participation"</span>, <span class="st">"Remote.Care.Monitoring"</span>,</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Risk.Profiling.and.Case.Management"</span>, <span class="st">"Rotavirus.and.Shingles.Immunisation"</span>,</span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Services.for.Violent.Patients"</span>, <span class="st">"Unplanned.Admissions"</span>,</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total.National.Enhanced.Services"</span>, <span class="st">"Total.Local.Enhanced.Services"</span>,</span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Non.DES.Item.Pneumococcal.Vaccine..Childhood.Immunisation.Main.Programme"</span>,</span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2016</span></span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Out.Of.Area.in.Hours.Urgent.Care"</span>, <span class="st">"Meningitis"</span>,</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>  <span class="co"># These 2 total to make Total.Local.Enhances.Services in 2016:</span></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">#    "LocalEnhancedServices_NHAIS_", "LocalEnhancedServices_ISFE_",</span></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pertussis"</span>,</span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Total.Local.Incentive.Schemes"</span>, <span class="st">"Local.Incentive.Schemes"</span>,</span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Weight.Management.Service"</span>,</span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Medical.Assessment.Reviews"</span></span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Covid.Immunisation", "Covid.Support.and.Expansion",</span></span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Long.Covid"</span></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a>COVID <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Covid.Immunisation"</span>, <span class="st">"Covid.Support.and.Expansion"</span>,</span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Long.Covid"</span></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>Prescribing <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Prescribing.Fee.Payments"</span>, <span class="st">"Dispensing.Fee.Payments"</span>,</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Reimbursement.of.Drugs"</span></span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>Total.Global.Sum <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(nhs_payments[, globalSum], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>Total.IT.Premises <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(nhs_payments[, ITPremises], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>Total.PCO <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(nhs_payments[, PCO], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>Total.Contracted.Services <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(nhs_payments[, contractedServices], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>Total.Prescribing <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(nhs_payments[, Prescribing], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>nhs_payments<span class="sc">$</span>Total.COVID <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(nhs_payments[, COVID], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Global Sum</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Total.Global.Sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">IT &amp; Premises</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Total.IT.Premises, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">PCO Payments</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Total.PCO, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Contracted Services</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Total.Contracted.Services, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Prescribing</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Total.Prescribing, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">COVID-19</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">sum</span>(Total.COVID, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Year, <span class="at">names_to =</span> <span class="st">"Payment Category"</span>, <span class="at">values_to =</span> <span class="st">"Total (£)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Total (£)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">label_comma</span>()(<span class="fu">round</span>(<span class="st">`</span><span class="at">Total (£)</span><span class="st">`</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 54 × 3
    Year `Payment Category`  `Total (£)`  
   &lt;dbl&gt; &lt;chr&gt;               &lt;chr&gt;        
 1  2015 Global Sum          4,410,434,227
 2  2015 IT &amp; Premises       672,107,043  
 3  2015 PCO Payments        611,784,475  
 4  2015 Contracted Services 802,764,294  
 5  2015 Prescribing         770,841,139  
 6  2015 COVID-19            0            
 7  2016 Global Sum          4,606,796,159
 8  2016 IT &amp; Premises       739,487,955  
 9  2016 PCO Payments        462,787,554  
10  2016 Contracted Services 901,854,909  
# ℹ 44 more rows</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"data/data_processing.R"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the function to merge and assign national-level quintiles</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="ot">&lt;-</span> <span class="fu">merge_and_assign_quintiles</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> nhs_payments,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_year =</span> <span class="dv">2015</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">end_year =</span> <span class="dv">2023</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Year: 2015"

   1    2    3    4    5 
1589 1589 1588 1588 1588 
[1] "Year: 2016"

   1    2    3    4    5 
1565 1565 1565 1565 1564 
[1] "Year: 2017"

   1    2    3    4    5 
1547 1546 1546 1546 1546 
[1] "Year: 2018"

   1    2    3    4    5 
1502 1502 1502 1502 1501 
[1] "Year: 2019"

   1    2    3    4    5 
1453 1453 1453 1452 1452 
[1] "Year: 2020"

   1    2    3    4    5 
1397 1396 1396 1396 1396 
[1] "Year: 2021"

   1    2    3    4    5 
1357 1357 1357 1357 1357 
[1] "Year: 2022"

   1    2    3    4    5 
1347 1347 1347 1347 1346 
[1] "Year: 2023"

   1    2    3    4    5 
1329 1329 1328 1328 1328 </code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count missing IMD values per year</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing_imd =</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(IMD))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
   Year missing_imd
  &lt;dbl&gt;       &lt;int&gt;
1  2015          17
2  2016          17
3  2017          32
4  2018          34
5  2019          16
6  2020          20
7  2021          23
8  2022          24
9  2023          27</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate payments excluding COVID and PCN payments for consistency</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>payments_clean <span class="ot">&lt;-</span> nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total.NHS.Payments.Minus.COVID.PCN =</span> Total.NHS.Payments.to.General.Practice <span class="sc">-</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Total.COVID.Payments), <span class="dv">0</span>, Total.COVID.Payments) <span class="sc">-</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(<span class="fu">is.na</span>(Total.PCN.Payments), <span class="dv">0</span>, Total.PCN.Payments)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average payments per weighted patient by IMD quintile and year</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>payments_by_imd <span class="ot">&lt;-</span> payments_clean <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(IMD_quintile)) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year, IMD_quintile) <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_registered_patients =</span> <span class="fu">sum</span>(Number.of.Registered.Patients..Last.Known.Figure., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_weighted_patients =</span> <span class="fu">sum</span>(Number.of.Weighted.Patients..Last.Known.Figure., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_payments =</span> <span class="fu">sum</span>(Total.NHS.Payments.Minus.COVID.PCN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_payment_per_registered_patient =</span> total_payments <span class="sc">/</span> total_registered_patients,</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_payment_per_weighted_patient =</span> total_payments <span class="sc">/</span> total_weighted_patients,</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">IMD_quintile =</span> <span class="fu">factor</span>(IMD_quintile, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>payments_by_imd <span class="sc">%&gt;%</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> Year, <span class="at">y =</span> avg_payment_per_weighted_patient,</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> IMD_quintile, <span class="at">group =</span> IMD_quintile</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> imd_colors,</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"IMD Quintile"</span>,</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"1 (least deprived)"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5 (most deprived)"</span>)</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average payment per weighted patient (£)"</span>,</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NHS Payments per Weighted Patient by Deprivation Level"</span>,</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Total NHS payments (excluding COVID and PCN) per weighted patient by IMD quintile"</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)) <span class="sc">+</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">unique</span>(payments_by_imd<span class="sc">$</span>Year)) <span class="sc">+</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/payments_weighted-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="age-group-data" class="level2">
<h2 class="anchored" data-anchor-id="age-group-data">Age Group Data</h2>
<p>The Office for Health Improvement and Disparities (OHID) provides data on the proportion of GP registered populations by age group through the Fingertips platform. This data helps analyze how the age structure of practice populations affects NHS payments.</p>
<p>The data can be accessed through the <a href="https://fingertips.phe.org.uk/api">Fingertips API</a> using indicator ID 93468.</p>
<p>Execute the following code to retrieve and process the age group data:</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load age group data and merge with payments data</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>age_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/age_group/age.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">==</span> <span class="dv">2023</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge age data with payments and IMD data</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>age_analysis <span class="ot">&lt;-</span> nhs_payments <span class="sc">%&gt;%</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(age_data, <span class="at">by =</span> <span class="st">"Practice.Code"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    Total.NHS.Payments.to.General.Practice <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    Average.payments.per.registered.patient <span class="sc">&lt;</span> <span class="dv">600</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(prop65),</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(IMD)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">prop65_quintile =</span> <span class="fu">ntile</span>(prop65, <span class="dv">5</span>),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">average_payment_per_patient =</span> Total.NHS.Payments.to.General.Practice <span class="sc">/</span> Number.of.Registered.Patients..Last.Known.Figure.</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Display basic statistics</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>age_analysis <span class="sc">%&gt;%</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(prop65_quintile) <span class="sc">%&gt;%</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_practices =</span> <span class="fu">n</span>(),</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_prop65 =</span> <span class="fu">mean</span>(prop65, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_payment =</span> <span class="fu">mean</span>(average_payment_per_patient, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_imd =</span> <span class="fu">mean</span>(IMD, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 5
  prop65_quintile n_practices mean_prop65 mean_payment mean_imd
            &lt;int&gt;       &lt;int&gt;       &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;
1               1        1271        7.97         153.     30.8
2               2        1271       13.8          158.     27.6
3               3        1270       17.9          168.     23.2
4               4        1270       21.7          181.     19.2
5               5        1270       28.0          230.     15.9</code></pre>
</div>
</div>
</section>
<section id="satisfaction" class="level2">
<h2 class="anchored" data-anchor-id="satisfaction">Satisfaction</h2>
<p>The GP Patient Survey is an independent survey run by Ipsos MORI on behalf of NHS England on the GP Patient Survey website. The survey is sent out to over a million people across the UK and covers a range of topics related to the quality of care provided by GP practices. The data from the survey is used to assess patient experience and satisfaction with GP services.</p>
<p>Annual practice-level .csv files are available [here].</p>
<p>Execute the following code to merge the data to create a single time-series dataset:</p>
<!-- ```{r sastifaction_data}
practice_information <- c("Practice_Code", "Practice_Name", "CCG_Code", "CCG_Name", "ICS_Code", "ICS_Name")

# Define the variable mappings as a named list
variable_mappings <- list(
  access_pct = "Q3_12pct",
  continuity_pct = "Q9_12pct",
  overall_pct = "Q28_12pct",
  trust_pct_default = "Q89_12pct",
  trust_pct_2017 = "Q22_12pct"
)

# Initialize empty data frames
satisfaction <- data.frame()
trust <- data.frame()

# Function to load and process a single file
process_file <- function(file, variables) {
  df <- read.csv(paste0("data/satisfaction/raw/", file))

  # Select CCG or ICB Code
  dataset_columns <- colnames(df)
  selected_column_names <- intersect(practice_information, dataset_columns)
  df <- df[, c(selected_column_names, variables)]

  # Assign year
  year <- substr(file, 1, nchar(file) - 4)
  df$Year <- as.numeric(year)

  return(df)
}

# Process all files for satisfaction
for (file in list.files("data/satisfaction/raw/")) {
  df <- process_file(file, unlist(variable_mappings[-c(4, 5)])) # Exclude trust variables, as the variable code is not consistent; it will be collated separately
  satisfaction <- bind_rows(satisfaction, df)
}

# Process a subset of files for trust
for (file in list.files("data/satisfaction/raw/")) {
  year <- as.numeric(substr(file, 1, nchar(file) - 4))
  trust_variable <- ifelse(year == 2017, variable_mappings$trust_pct_2017, variable_mappings$trust_pct_default)
  df <- process_file(file, c("Practice_Code", trust_variable))

  # Rename the trust column to a common name for merging
  colnames(df)[colnames(df) == trust_variable] <- "trust_pct"

  trust <- bind_rows(trust, df)
}

# Keep only the relevant columns in trust
trust <- trust[, c("Practice_Code", "trust_pct", "Year")]

# Merge satisfaction and trust data frames
satisfaction <- merge(satisfaction, trust, by = c("Practice_Code", "Year"), all.x = TRUE)

# Rename columns based on variable_mappings
for (new_name in names(variable_mappings)[-c(4, 5)]) { # Exclude trust variables
  old_name <- variable_mappings[[new_name]]
  colnames(satisfaction)[colnames(satisfaction) == old_name] <- new_name
}

# Rename Practice_Code and Practice_Name
satisfaction <- satisfaction %>%
  rename(
    `Practice.Code` = Practice_Code,
    `Practice.Name` = Practice_Name
  )

# drop rows where pct is negative
satisfaction$overall_pct <- ifelse(satisfaction$overall_pct < 0, NA, satisfaction$overall_pct)
satisfaction$access_pct <- ifelse(satisfaction$access_pct < 0, NA, satisfaction$access_pct)
satisfaction$continuity_pct <- ifelse(satisfaction$continuity_pct < 0, NA, satisfaction$continuity_pct)
satisfaction$trust_pct <- ifelse(satisfaction$trust_pct < 0, NA, satisfaction$trust_pct)

satisfaction %>%
  group_by(Year) %>%
  summarise(
    mean_overall = mean(overall_pct, na.rm = TRUE),
    sd_overall = sd(overall_pct, na.rm = TRUE),
    min_overall = min(overall_pct, na.rm = TRUE),
    max_overall = max(overall_pct, na.rm = TRUE),
    n = n()
  )
``` -->
<!-- ```{r clean_satisfaction}
# match CCG.Code in df with CCG.Code in CCG_ICB and return ICB.Code
satisfaction$ICB.NAME <- CCG_ICB[match(satisfaction$CCG_Code, CCG_ICB$CCG.Code), ]$ICB.NAME
satisfaction[is.na(satisfaction$ICB.NAME), ]$ICB.NAME <- CCG_ICB[match(satisfaction[is.na(satisfaction$ICB.NAME), ]$ICS_Code, CCG_ICB$ICB.Code), ]$ICB.NAME

satisfaction$ICB.NAME <- gsub("NHS ", "", satisfaction$ICB.NAME)
satisfaction$ICB.NAME <- gsub(" Integrated Care Board", "", satisfaction$ICB.NAME)

satisfaction <- satisfaction[, c("Practice.Code", "Practice.Name", "ICB.NAME", "Year", "overall_pct", "continuity_pct", "access_pct", "trust_pct")]

# Call the function to merge and assign national-level quintiles
satisfaction <- merge_and_assign_quintiles(
  data = satisfaction
)

satisfaction %>%
  group_by(Year) %>%
  summarise(
    missing_imd = sum(is.na(IMD))
  )
``` -->
</section>
<section id="gp-workforce" class="level2">
<h2 class="anchored" data-anchor-id="gp-workforce">GP Workforce</h2>
<p>NHS Digital provides monthly data on the general practice workforce, including fully-qualified GPs, locums, nurses, and administrative staff. The data is reported annually from September 2015-2020, quarterly from December 2020-June 2021, and monthly from July 2021 onwards.</p>
<p><strong>Rationale for Annual Grouping</strong>: Monthly workforce data exhibits natural fluctuations due to factors such as training cycles, holiday periods, and staff recruitment patterns. Aggregating to annual data provides several advantages:</p>
<ol type="1">
<li><strong>Consistency with financial reporting</strong>: Using financial year grouping (April-March) aligns with NHS budget cycles and other healthcare datasets in this analysis</li>
<li><strong>Smoothing seasonal variation</strong>: Monthly variations in staffing can obscure underlying trends and make year-over-year comparisons less reliable</li>
<li><strong>Data completeness</strong>: Not all practices report workforce data every month, so annual aggregation maximizes data coverage</li>
<li><strong>Improved analytical stability</strong>: Annual averages reduce the impact of temporary staffing changes and provide more stable metrics for comparative analysis</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and process GP workforce data</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>workforce_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/workforce/raw/"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>workforce <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> workforce_files) {</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file)[<span class="fu">c</span>(</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PRAC_CODE"</span>, <span class="st">"TOTAL_PATIENTS"</span>, <span class="st">"TOTAL_GP_EXTGL_FTE"</span>, <span class="st">"TOTAL_GP_FTE"</span>, </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TOTAL_NURSES_FTE"</span>, <span class="st">"TOTAL_GP_EXL_FTE"</span>, <span class="st">"TOTAL_DPC_FTE"</span>, <span class="st">"TOTAL_ADMIN_FTE"</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TOTAL_GP_SEN_PTNR_FTE"</span>, <span class="st">"TOTAL_GP_PTNR_PROV_FTE"</span>, <span class="st">"TOTAL_N_NURSE_PTNR_FTE"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TOTAL_ADMIN_MANAGE_PTNR_FTE"</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  )]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract year and month from filename</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  filename <span class="ot">&lt;-</span> <span class="fu">basename</span>(file)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  parts <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(filename, <span class="st">"_"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  year <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(parts[<span class="dv">1</span>])</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>  month <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.csv"</span>, <span class="st">""</span>, parts[<span class="dv">2</span>]))</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Year <span class="ot">&lt;-</span> year</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>Month <span class="ot">&lt;-</span> month</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Determine financial year (April-March)</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (month <span class="sc">&gt;=</span> <span class="dv">4</span>) {</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>fiscal_year <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"20"</span>, year <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    df<span class="sc">$</span>fiscal_year <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"20"</span>, year)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>  workforce <span class="ot">&lt;-</span> <span class="fu">rbind</span>(workforce, df)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to numeric</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>numeric_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"TOTAL_PATIENTS"</span>, <span class="st">"TOTAL_GP_EXTGL_FTE"</span>, <span class="st">"TOTAL_GP_FTE"</span>, </span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"TOTAL_NURSES_FTE"</span>, <span class="st">"TOTAL_GP_EXL_FTE"</span>, <span class="st">"TOTAL_DPC_FTE"</span>, </span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"TOTAL_ADMIN_FTE"</span>, <span class="st">"TOTAL_GP_SEN_PTNR_FTE"</span>, <span class="st">"TOTAL_GP_PTNR_PROV_FTE"</span>,</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"TOTAL_N_NURSE_PTNR_FTE"</span>, <span class="st">"TOTAL_ADMIN_MANAGE_PTNR_FTE"</span>)</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>workforce[numeric_cols] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(workforce[numeric_cols], as.numeric)</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create derived variables</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>workforce <span class="ot">&lt;-</span> workforce <span class="sc">%&gt;%</span></span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_LOCUUM_TRN_FTE =</span> TOTAL_GP_FTE <span class="sc">-</span> TOTAL_GP_EXTGL_FTE,</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_PTNR_PER_GP_FTE =</span> (TOTAL_GP_PTNR_PROV_FTE <span class="sc">+</span> TOTAL_GP_SEN_PTNR_FTE) <span class="sc">/</span> TOTAL_GP_EXTGL_FTE</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate annual averages by practice and fiscal year</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>workforce_annual <span class="ot">&lt;-</span> workforce <span class="sc">%&gt;%</span></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(PRAC_CODE, fiscal_year) <span class="sc">%&gt;%</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_PATIENTS =</span> <span class="fu">mean</span>(TOTAL_PATIENTS, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_GP_EXTGL_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_GP_EXTGL_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_LOCUUM_TRN_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_LOCUUM_TRN_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_NURSES_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_NURSES_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_DPC_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_DPC_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_ADMIN_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_ADMIN_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_GP_SEN_PTNR_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_GP_SEN_PTNR_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_GP_PTNR_PROV_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_GP_PTNR_PROV_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_N_NURSE_PTNR_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_N_NURSE_PTNR_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_ADMIN_MANAGE_PTNR_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_ADMIN_MANAGE_PTNR_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">TOTAL_PTNR_PER_GP_FTE =</span> <span class="fu">round</span>(<span class="fu">mean</span>(TOTAL_PTNR_PER_GP_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>),</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Practice.Code =</span> PRAC_CODE, <span class="at">Year =</span> fiscal_year)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with IMD data and assign quintiles</span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>workforce_annual <span class="ot">&lt;-</span> <span class="fu">merge_and_assign_quintiles</span>(</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> workforce_annual,</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">start_year =</span> <span class="dv">2016</span>,</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">end_year =</span> <span class="dv">2024</span></span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Year: 2016"

   1    2    3    4    5 
1524 1524 1524 1524 1523 
[1] "Year: 2017"

   1    2    3    4    5 
1508 1508 1507 1507 1507 
[1] "Year: 2018"

   1    2    3    4    5 
1467 1467 1466 1466 1466 
[1] "Year: 2019"

   1    2    3    4    5 
1427 1426 1426 1426 1426 
[1] "Year: 2020"

   1    2    3    4    5 
1372 1371 1371 1371 1371 
[1] "Year: 2021"

   1    2    3    4    5 
1327 1327 1327 1327 1327 
[1] "Year: 2022"

   1    2    3    4    5 
1313 1313 1313 1313 1312 
[1] "Year: 2023"

   1    2    3    4    5 
1295 1295 1295 1295 1295 
[1] "Year: 2024"

   1    2    3    4    5 
1274 1274 1274 1273 1273 </code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>workforce_annual<span class="sc">$</span>ICB.NAME <span class="ot">&lt;-</span> CCG_ICB[<span class="fu">match</span>(workforce_annual<span class="sc">$</span>Practice.Code, CCG_ICB<span class="sc">$</span>Practice.Code), ]<span class="sc">$</span>ICB.NAME</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Display summary statistics</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>workforce_annual <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">practices =</span> <span class="fu">n</span>(),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_gp_fte =</span> <span class="fu">mean</span>(TOTAL_GP_EXTGL_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_admin_fte =</span> <span class="fu">mean</span>(TOTAL_ADMIN_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_patients =</span> <span class="fu">mean</span>(TOTAL_PATIENTS, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   Year  practices avg_gp_fte avg_admin_fte avg_patients
   &lt;chr&gt;     &lt;int&gt;      &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
 1 2016       7623       3.59          7.53        7465.
 2 2017       7558       3.70          8.31        7654.
 3 2018       7354       3.76          8.59        7978.
 4 2019       7137       3.83          9.16        8315.
 5 2020       6867       3.95          9.80        8737.
 6 2021       6652       4.07         10.4         9115.
 7 2022       6587       4.09         10.8         9320.
 8 2023       6503       4.12         11.3         9557.
 9 2024       6395       4.21         11.8         9850.
10 2025       6293       4.35         12.2        10099.</code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create GP workforce per patient chart by deprivation level</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>workforce_by_imd <span class="ot">&lt;-</span> workforce_annual <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(IMD_quintile)) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">as.numeric</span>(Year)) <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year, IMD_quintile) <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_patients =</span> <span class="fu">sum</span>(TOTAL_PATIENTS, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_gp_fte =</span> <span class="fu">sum</span>(TOTAL_GP_EXTGL_FTE, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">gp_fte_per_10000_patients =</span> (total_gp_fte <span class="sc">/</span> total_patients) <span class="sc">*</span> <span class="dv">10000</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">IMD_quintile =</span> <span class="fu">factor</span>(IMD_quintile, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the workforce chart</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>workforce_by_imd <span class="sc">%&gt;%</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> Year, <span class="at">y =</span> gp_fte_per_10000_patients,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> IMD_quintile, <span class="at">group =</span> IMD_quintile</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">2.5</span>, <span class="at">alpha =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> imd_colors,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"IMD Quintile"</span>,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"1 (least deprived)"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5 (most deprived)"</span>)</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"GP FTE per 10,000 patients"</span>,</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"GP Workforce Density by Deprivation Level"</span>,</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Fully qualified GP FTE per 1,000 patients by IMD quintile"</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">unique</span>(workforce_by_imd<span class="sc">$</span>Year)) <span class="sc">+</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/workforce_processing-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="gp-earnings" class="level2">
<h2 class="anchored" data-anchor-id="gp-earnings">GP Earnings</h2>
<p>NHS Digital publishes annual data on GP earnings based on tax returns submitted by GP practices. This dataset provides insights into GP income levels across different practice types, geographical regions, and practice characteristics from 2016-2023.</p>
<p>The earnings data includes total earnings, expenses, income before tax for both partners and salaried GPs, income distribution percentiles, and inflation-adjusted figures using GDP deflator and RPI.</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load GP earnings data</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>gp_earnings <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/GP_earnings/raw/GP_earn_exp.csv"</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display basic structure</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gp_earnings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Country Region Practice.type Rurality Size Year Mean.Total.Partners.HC
1 England    All           All      All  All 2016                   3.13
2 England    All           All      All  All 2017                   3.15
3 England    All           All      All  All 2018                   3.12
4 England    All           All      All  All 2019                   3.14
5 England    All           All      All  All 2020                   3.13
6 England    All           All      All  All 2021                   3.08
  Mean.Total.Partners.FTE Mean.Total.GP..fully.qualified..HC
1                    2.74                               4.87
2                    2.72                               5.22
3                    2.68                               5.31
4                    2.68                               5.57
5                    2.65                               5.78
6                    2.58                               5.89
  Mean.Total.GP..fully.qualified..FTE Mean.Male.Partners.HC
1                                3.80                  1.79
2                                3.93                  1.79
3                                3.96                  1.76
4                                4.10                  1.75
5                                4.20                  1.73
6                                4.23                  1.69
  Mean.Female.Partners.HC Mean.Total.GP.HC Mean.Total.GP.FTE
1                    1.34             5.13              4.03
2                    1.36             5.47              4.14
3                    1.36             6.04              4.68
4                    1.39             6.43              4.93
5                    1.40             6.81              5.20
6                    1.39             7.09              5.41
  Mean.Total.Payments Mean.Total.Payments.incl.COVID.PCN
1              940025                                 NA
2             1047506                                 NA
3             1103759                                 NA
4             1174592                                 NA
5             1238576                                 NA
6             1309267                                 NA
  Payments.per.Partner.HC Total.Earnings Total.Expenses
1                300327.5         314900         210000
2                332541.6         338300         228700
3                353768.9         357300         243900
4                374073.9         380900         263600
5                395711.2         402600         280800
6                425086.7         438700         296700
  Income.before.tax.D1..salaried. Income.before.tax..salaried.
1                           27700                        55900
2                           27800                        56600
3                           28200                        58400
4                           29700                        60600
5                           31800                        63600
6                           32000                        64900
  Income.before.tax.D9..salaried. Income.before.tax.D1..contractor.
1                           86800                             54700
2                           89400                             56800
3                           92900                             58200
4                           95600                             62300
5                           99000                             66400
6                          101600                             77200
  Income.before.tax..contractor. Income.before.tax.D9..contractor.
1                         104900                            151900
2                         109600                            158300
3                         113400                            165500
4                         117300                            177400
5                         121800                            183900
6                         142000                            215600
  Income.before.tax..GDP.deflator. Income.before.tax..RPI.deflator. GDP.delator
1                           127100                           142000        1.21
2                           122900                           145300        1.12
3                           132300                           144900        1.17
4                           134000                           145400        1.14
5                           135900                           147200        1.12
6                           150300                           169500        1.06
  RPI.deflator Report.population
1         1.35             18300
2         1.33             19850
3         1.28             20350
4         1.24             20300
5         1.21             19250
6         1.19             18600</code></pre>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dispensing vs non-dispensing partner income chart</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>practice_type_earnings <span class="ot">&lt;-</span> gp_earnings <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    Country <span class="sc">==</span> <span class="st">"England"</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    Region <span class="sc">==</span> <span class="st">"All"</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    Practice.type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Dispensing"</span>, <span class="st">"Non-dispensing"</span>),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    Rurality <span class="sc">==</span> <span class="st">"All"</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    Size <span class="sc">==</span> <span class="st">"All"</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">as.numeric</span>(Year)) <span class="sc">%&gt;%</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Year))</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create partner income chart by practice size</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>practice_size_earnings <span class="ot">&lt;-</span> gp_earnings <span class="sc">%&gt;%</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    Country <span class="sc">==</span> <span class="st">"England"</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    Region <span class="sc">==</span> <span class="st">"All"</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    Practice.type <span class="sc">==</span> <span class="st">"All"</span>,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    Rurality <span class="sc">==</span> <span class="st">"All"</span>,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    Size <span class="sc">!=</span> <span class="st">"All"</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Year =</span> <span class="fu">as.numeric</span>(Year)) <span class="sc">%&gt;%</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Year))</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the practice size comparison chart</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>practice_size_earnings <span class="sc">%&gt;%</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> Income.before.tax..contractor., <span class="at">color =</span> Size)) <span class="sc">+</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> heec_colors) <span class="sc">+</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partner income before tax (£)"</span>,</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Partner Income by Practice List Size"</span>,</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Partner income before tax by practice size over time"</span>,</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Practice Size"</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)) <span class="sc">+</span></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">unique</span>(practice_size_earnings<span class="sc">$</span>Year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/gp_earnings_processing-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="analysis" class="level1">
<h1>Analysis</h1>
<section id="structural-inequalities-in-primary-care-the-facts-and-figures" class="level2">
<h2 class="anchored" data-anchor-id="structural-inequalities-in-primary-care-the-facts-and-figures">1. <a href="https://www.heec.co.uk/resource/structural-inequalities-primary-care/">Structural inequalities in primary care – the facts and figures</a></h2>
<p>The factors determining the quality and quantity of primary care services vary across England. Here we analyse practice level data relating to the supply, demand, and need for primary care, according to the socioeconomic status of the patients served.</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>payments <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/payments/payments.csv"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>agg <span class="ot">&lt;-</span> payments[payments<span class="sc">$</span>Year <span class="sc">==</span> <span class="dv">2023</span>, ] <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ICB.NAME) <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Registered =</span> <span class="fu">sum</span>(Number.of.Registered.Patients..Last.Known.Figure., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Weighted =</span> <span class="fu">sum</span>(Number.of.Weighted.Patients..Last.Known.Figure., <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>agg<span class="sc">$</span>Difference <span class="ot">&lt;-</span> agg<span class="sc">$</span>Weighted <span class="sc">-</span> agg<span class="sc">$</span>Registered</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>agg<span class="sc">$</span>Percent.change <span class="ot">&lt;-</span> agg<span class="sc">$</span>Difference <span class="sc">/</span> agg<span class="sc">$</span>Registered</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co"># sort by ascending difference</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>agg <span class="ot">&lt;-</span> agg[<span class="fu">order</span>(agg<span class="sc">$</span>Percent.change), ]</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create consistent chart</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>agg <span class="sc">%&gt;%</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ICB.NAME =</span> <span class="fu">factor</span>(ICB.NAME, <span class="at">levels =</span> <span class="fu">unique</span>(ICB.NAME))) <span class="sc">%&gt;%</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(ICB.NAME, Percent.change), <span class="at">y =</span> Percent.change, <span class="at">fill =</span> ICB.NAME)) <span class="sc">+</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">rep</span>(my_colors, <span class="at">length.out =</span> <span class="dv">42</span>)) <span class="sc">+</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Integrated Care Board"</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percent difference"</span>,</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Percentage Difference between Registered and Weighted Patients"</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Higher values indicate greater healthcare need relative to population size"</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/weighted-patients, echo- true-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate total count by Year, ICB.NAME</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>total_counts <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year, ICB.NAME) <span class="sc">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate count and percentage by IMD_quintile for all ICBs</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">==</span> <span class="dv">2019</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Year, IMD_quintile, ICB.NAME) <span class="sc">%&gt;%</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(total_counts, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">"ICB.NAME"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">perc =</span> (n <span class="sc">/</span> total) <span class="sc">*</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Year, ICB.NAME, IMD_quintile, n, perc)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for visualization</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> result <span class="sc">%&gt;%</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(IMD_quintile)) <span class="sc">%&gt;%</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">complete</span>(ICB.NAME, <span class="at">IMD_quintile =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">perc =</span> <span class="dv">0</span>))</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the percentage of practices in most deprived quintile for ordering</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>ordered_ICB <span class="ot">&lt;-</span> t <span class="sc">%&gt;%</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(IMD_quintile <span class="sc">==</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ICB.NAME) <span class="sc">%&gt;%</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">max_perc =</span> <span class="fu">max</span>(perc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(max_perc)) <span class="sc">%&gt;%</span></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ICB.NAME)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder ICB names and create proper factor levels</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> t <span class="sc">%&gt;%</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">ICB.NAME =</span> <span class="fu">factor</span>(ICB.NAME, <span class="at">levels =</span> ordered_ICB),</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">IMD_quintile =</span> <span class="fu">factor</span>(IMD_quintile, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>t <span class="sc">%&gt;%</span></span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> ICB.NAME, <span class="at">y =</span> perc, <span class="at">fill =</span> IMD_quintile)) <span class="sc">+</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"fill"</span>, <span class="at">width =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">percent_format</span>(<span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> imd_colors,</span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"IMD Quintile"</span>,</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"1 (least deprived)"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5 (most deprived)"</span>)</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Integrated Care Board"</span>,</span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage of practices"</span>,</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of GP Practices by Deprivation Quintile"</span>,</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Percentage of practices in each IMD quintile by ICB (2019)"</span></span>
<span id="cb36-51"><a href="#cb36-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-52"><a href="#cb36-52" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb36-53"><a href="#cb36-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb36-54"><a href="#cb36-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb36-55"><a href="#cb36-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">9</span>)</span>
<span id="cb36-56"><a href="#cb36-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-57"><a href="#cb36-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb36-58"><a href="#cb36-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/ICB_dist-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<p><a href="https://heec.shinyapps.io/QOF_shiny/">QOF Shiny App</a></p>
</section>
<section id="nhs-payments-to-practices-in-the-east-of-england" class="level2">
<h2 class="anchored" data-anchor-id="nhs-payments-to-practices-in-the-east-of-england">2. <a href="https://www.heec.co.uk/resource/nhs-payments-general-practice-east-england/">NHS payments to practices in the East of England</a></h2>
<p>In this resource, we explore structural inequalities in primary care at the ICB level in the East of England. We provide data on NHS payments to GP surgeries, payments per weighted patient and patient satisfaction, showing differences across socioeconomic groups.</p>
<ul>
<li><strong>Charts</strong>:
<ul>
<li><a href="https://heec.shinyapps.io/Payments_shiny/">Payments per weighted patient</a></li>
<li><a href="https://heec.shinyapps.io/Type_shiny/">Total payments by type</a></li>
<li><a href="https://heec.shinyapps.io/Satisfaction_shiny/">Overall experience by ICB</a></li>
</ul></li>
</ul>
</section>
<section id="what-does-the-latest-gp-patient-survey-tell-us-about-socio-economic-inequalities-in-general-practice" class="level2">
<h2 class="anchored" data-anchor-id="what-does-the-latest-gp-patient-survey-tell-us-about-socio-economic-inequalities-in-general-practice">3. <a href="https://www.heec.co.uk/resource/what-does-the-latest-gp-patient-survey-tell-us-about-socio-economic-inequalities-in-general-practice/">What does the latest GP Patient Survey tell us about socio-economic inequalities in general practice?</a></h2>
<p>Overall patient satisfaction with general practice has improved slightly according to the GP Patient Survey 2024, but remains substantially lower than pre-pandemic levels. Patient satisfaction is not the same across the country. Read more to understand inequalities in patient satisfaction from the latest data.</p>
<ul>
<li><strong>Charts</strong>:
<ul>
<li><a href="https://heec.shinyapps.io/GPPS/">GPPS by ICB</a></li>
<li><a href="https://heec.shinyapps.io/overall_shiny/">Overall satisfaction</a></li>
<li><a href="https://heec.shinyapps.io/access_shiny/">Experience contacting surgery</a></li>
<li><a href="https://heec.shinyapps.io/continuity_shiny/">Continuity</a></li>
<li><a href="https://heec.shinyapps.io/trust_shiny/">Confidence</a></li>
</ul></li>
</ul>
</section>
<section id="exploring-the-impact-of-dispensing-practices-on-equity-in-nhs-payments-to-general-practices" class="level2">
<h2 class="anchored" data-anchor-id="exploring-the-impact-of-dispensing-practices-on-equity-in-nhs-payments-to-general-practices">4. <a href="https://www.heec.co.uk/resource/exploring-the-impact-of-dispensing-practicing-on-equity-in-nhs-payments-to-general-practices/">Exploring the impact of dispensing practices on equity in NHS payments to general practices</a></h2>
<p>In 2023, 6,669 general practices received £10.2 billion in NHS funding across England, increasing to £11 billion with COVID-related and Primary Care Network (PCN) payments. Almost 10% of this—£870 million—was allocated to prescribing- and dispensing-related payments, supporting 944 dispensing practices serving 9.5 million patients (£625 million) and 5,537 non-dispensing practices covering 53 million patients (£245 million).</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the most recent year of payments data (2023)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>dispensing_data <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">==</span> <span class="dv">2023</span>, <span class="sc">!</span><span class="fu">is.na</span>(IMD_quintile))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate average payment per weighted patient for dispensing vs non-dispensing practices</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co"># by IMD quintile (comparing Q1 and Q5 only)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>dispensing_comparison <span class="ot">&lt;-</span> dispensing_data <span class="sc">%&gt;%</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    IMD_quintile <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    Dispensing.Practice <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(IMD_quintile, Dispensing.Practice) <span class="sc">%&gt;%</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_payments =</span> <span class="fu">sum</span>(Total.NHS.Payments.to.General.Practice, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_weighted_patients =</span> <span class="fu">sum</span>(Number.of.Weighted.Patients..Last.Known.Figure., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">payment_per_patient =</span> total_payments <span class="sc">/</span> total_weighted_patients</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add overall averages for Q1 and Q5</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>overall_comparison <span class="ot">&lt;-</span> dispensing_data <span class="sc">%&gt;%</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(IMD_quintile <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(IMD_quintile) <span class="sc">%&gt;%</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_payments =</span> <span class="fu">sum</span>(Total.NHS.Payments.to.General.Practice, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_weighted_patients =</span> <span class="fu">sum</span>(Number.of.Weighted.Patients..Last.Known.Figure., <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">payment_per_patient =</span> total_payments <span class="sc">/</span> total_weighted_patients,</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">Dispensing.Practice =</span> <span class="st">"All practices"</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(IMD_quintile, Dispensing.Practice, payment_per_patient)</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine the data</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>plot_data <span class="ot">&lt;-</span> dispensing_comparison <span class="sc">%&gt;%</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(IMD_quintile, Dispensing.Practice, payment_per_patient) <span class="sc">%&gt;%</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(overall_comparison) <span class="sc">%&gt;%</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Dispensing.Practice =</span> <span class="fu">case_when</span>(</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="st">"Dispensing practices"</span>,</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="st">"Non-dispensing practices"</span>,</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> Dispensing.Practice</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">Dispensing.Practice =</span> <span class="fu">factor</span>(</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice,</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Dispensing practices"</span>, <span class="st">"Non-dispensing practices"</span>, <span class="st">"All practices"</span>)</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">IMD_quintile =</span> <span class="fu">factor</span>(IMD_quintile, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>))</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>plot_data <span class="sc">%&gt;%</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> payment_per_patient, <span class="at">y =</span> Dispensing.Practice, <span class="at">color =</span> IMD_quintile)) <span class="sc">+</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"1"</span> <span class="ot">=</span> heec_colors[<span class="dv">1</span>], <span class="st">"5"</span> <span class="ot">=</span> heec_colors[<span class="dv">3</span>]),</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Least deprived (Q1)"</span>, <span class="st">"Most deprived (Q5)"</span>)</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NHS Payments per Weighted Patient by Practice Type and Deprivation"</span>,</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Comparison between most and least deprived areas (2023)"</span>,</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Payment per weighted patient (£)"</span>,</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">""</span>,</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"IMD Quintile"</span></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey90"</span>),</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)) <span class="sc">+</span></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/dispensing_analysis-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create side-by-side bar charts showing distribution of practices by IMD quintile</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for dispensing vs non-dispensing practices</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter 2023 data and create counts by dispensing status and IMD quintile</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>dispensing_counts <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Year <span class="sc">==</span> <span class="dv">2023</span>, <span class="sc">!</span><span class="fu">is.na</span>(IMD_quintile), Dispensing.Practice <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Dispensing.Practice, IMD_quintile) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Practice_Type =</span> <span class="fu">case_when</span>(</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="st">"Dispensing Practices"</span>,</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="st">"Non-dispensing Practices"</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">IMD_quintile =</span> <span class="fu">factor</span>(IMD_quintile, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>dispensing_counts <span class="sc">%&gt;%</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> IMD_quintile, <span class="at">y =</span> n, <span class="at">fill =</span> IMD_quintile)) <span class="sc">+</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Practice_Type, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> imd_colors,</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"IMD Quintile"</span>,</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"1 (least deprived)"</span>, <span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"4"</span>, <span class="st">"5 (most deprived)"</span>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Distribution of GP Practices by Deprivation Level"</span>,</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Number of dispensing vs non-dispensing practices by IMD quintile (2023)"</span>,</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"IMD Quintile"</span>,</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Number of practices"</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>),</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>),</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>()</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">reverse =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/dispensing_distribution-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatter plot showing relationship between IMD and payments per registered patient</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for dispensing vs non-dispensing practices</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter and clean the data for scatter plot</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>scatter_data <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    Year <span class="sc">==</span> <span class="dv">2023</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(IMD),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(Average.payments.per.registered.patient),</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    Dispensing.Practice <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    Total.NHS.Payments.to.General.Practice <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    Average.payments.per.registered.patient <span class="sc">&lt;</span> <span class="dv">600</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    Number.of.Registered.Patients..Last.Known.Figure. <span class="sc">!=</span> <span class="dv">0</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Practice_Type =</span> <span class="fu">case_when</span>(</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="st">"Dispensing"</span>,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="st">"Non-dispensing"</span></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrange so dispensing practices are plotted on top</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Practice_Type <span class="sc">==</span> <span class="st">"Dispensing"</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the scatter plot</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>scatter_data <span class="sc">%&gt;%</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> IMD, <span class="at">y =</span> Average.payments.per.registered.patient, <span class="at">color =</span> Practice_Type)) <span class="sc">+</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Dispensing"</span> <span class="ot">=</span> heec_colors[<span class="dv">5</span>], <span class="st">"Non-dispensing"</span> <span class="ot">=</span> heec_colors[<span class="dv">6</span>])</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NHS Payments per Registered Patient by Deprivation and Practice Type"</span>,</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Scatter plot showing relationship between IMD and average payments (2023)"</span>,</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Index of Multiple Deprivation (IMD)"</span>,</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average payments per registered patient (£)"</span></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">600</span>),</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">600</span>, <span class="at">by =</span> <span class="dv">100</span>),</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">70</span>),</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">70</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb39-45"><a href="#cb39-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-46"><a href="#cb39-46" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb39-47"><a href="#cb39-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-48"><a href="#cb39-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.98</span>, <span class="fl">0.98</span>),</span>
<span id="cb39-49"><a href="#cb39-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb39-50"><a href="#cb39-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-51"><a href="#cb39-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"grey90"</span>, <span class="at">size =</span> <span class="fl">0.5</span>),</span>
<span id="cb39-52"><a href="#cb39-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey90"</span>),</span>
<span id="cb39-53"><a href="#cb39-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb39-54"><a href="#cb39-54" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/dispensing_scatter-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatter plot showing relationship between IMD and payments per weighted patient</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for dispensing vs non-dispensing practices</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter and clean the data for scatter plot (weighted patients)</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>scatter_data_weighted <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    Year <span class="sc">==</span> <span class="dv">2023</span>,</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(IMD),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(Average.payments.per.weighted.patient),</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    Dispensing.Practice <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>),</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    Total.NHS.Payments.to.General.Practice <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    Average.payments.per.weighted.patient <span class="sc">&lt;</span> <span class="dv">600</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    Number.of.Weighted.Patients..Last.Known.Figure. <span class="sc">!=</span> <span class="dv">0</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Practice_Type =</span> <span class="fu">case_when</span>(</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="st">"Dispensing"</span>,</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="st">"Non-dispensing"</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrange so dispensing practices are plotted on top</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Practice_Type <span class="sc">==</span> <span class="st">"Dispensing"</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the scatter plot for weighted patients</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>scatter_data_weighted <span class="sc">%&gt;%</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> IMD, <span class="at">y =</span> Average.payments.per.weighted.patient, <span class="at">color =</span> Practice_Type)) <span class="sc">+</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Dispensing"</span> <span class="ot">=</span> heec_colors[<span class="dv">5</span>], <span class="st">"Non-dispensing"</span> <span class="ot">=</span> heec_colors[<span class="dv">6</span>])</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NHS Payments per Weighted Patient by Deprivation and Practice Type"</span>,</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Scatter plot showing relationship between IMD and average payments (2023)"</span>,</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"IMD (Higher = More deprived)"</span>,</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Payments per weighted patient (£)"</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">600</span>),</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">600</span>, <span class="at">by =</span> <span class="dv">100</span>),</span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">70</span>),</span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">70</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.98</span>, <span class="fl">0.98</span>),</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"grey90"</span>, <span class="at">size =</span> <span class="fl">0.5</span>),</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey90"</span>),</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/dispensing_scatter_weighted-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create scatter plot showing relationship between IMD and payments per weighted patient</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co"># excluding prescribing payments to show the effect of dispensing on inequality</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate payments excluding prescribing</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>scatter_data_no_prescribing <span class="ot">&lt;-</span> payments <span class="sc">%&gt;%</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    Year <span class="sc">==</span> <span class="dv">2023</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(IMD),</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    Dispensing.Practice <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Yes"</span>, <span class="st">"No"</span>),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    Total.NHS.Payments.to.General.Practice <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    Number.of.Weighted.Patients..Last.Known.Figure. <span class="sc">!=</span> <span class="dv">0</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate total prescribing payments</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total.Prescribing =</span> <span class="fu">rowSums</span>(<span class="fu">select</span>(</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>      .,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>      Prescribing.Fee.Payments,</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>      Dispensing.Fee.Payments,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>      Reimbursement.of.Drugs</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate payments minus prescribing</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">Total.NHS.Payments.minus.Prescribing =</span> Total.NHS.Payments.to.General.Practice <span class="sc">-</span> Total.Prescribing,</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate average payments per weighted patient excluding prescribing</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">Average.payments.minus.prescribing.per.weighted.patient =</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>      Total.NHS.Payments.minus.Prescribing <span class="sc">/</span> Number.of.Weighted.Patients..Last.Known.Figure.,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">Practice_Type =</span> <span class="fu">case_when</span>(</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"Yes"</span> <span class="sc">~</span> <span class="st">"Dispensing"</span>,</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>      Dispensing.Practice <span class="sc">==</span> <span class="st">"No"</span> <span class="sc">~</span> <span class="st">"Non-dispensing"</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(Average.payments.minus.prescribing.per.weighted.patient),</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    Average.payments.minus.prescribing.per.weighted.patient <span class="sc">&lt;</span> <span class="dv">600</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Arrange so dispensing practices are plotted on top</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Practice_Type <span class="sc">==</span> <span class="st">"Dispensing"</span>)</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the scatter plot excluding prescribing payments</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>scatter_data_no_prescribing <span class="sc">%&gt;%</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> IMD, <span class="at">y =</span> Average.payments.minus.prescribing.per.weighted.patient, <span class="at">color =</span> Practice_Type)) <span class="sc">+</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Dispensing"</span> <span class="ot">=</span> heec_colors[<span class="dv">5</span>], <span class="st">"Non-dispensing"</span> <span class="ot">=</span> heec_colors[<span class="dv">6</span>])</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NHS Payments per Weighted Patient (Excluding Prescribing) by Deprivation"</span>,</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Scatter plot showing relationship between IMD and payments excluding prescribing (2023)"</span>,</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"IMD (Higher = More deprived)"</span>,</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Payments (excluding prescribing) per weighted patient (£)"</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">600</span>),</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">600</span>, <span class="at">by =</span> <span class="dv">100</span>),</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">70</span>),</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">70</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.98</span>, <span class="fl">0.98</span>),</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.justification =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"grey90"</span>, <span class="at">size =</span> <span class="fl">0.5</span>),</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">"grey90"</span>),</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/dispensing_scatter_no_prescribing-1.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the dispensing comparison chart</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>practice_type_earnings <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Year, <span class="at">y =</span> Income.before.tax..contractor., <span class="at">color =</span> Practice.type)) <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Dispensing"</span> <span class="ot">=</span> <span class="st">"#531A5C"</span>, <span class="st">"Non-dispensing"</span> <span class="ot">=</span> <span class="st">"#EF7A34"</span>)) <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partner income before tax (£)"</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Partner Income: Dispensing vs Non-dispensing Practices"</span>,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Partner income before tax by practice type over time"</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Practice Type"</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">0</span>)</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>)) <span class="sc">+</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">unique</span>(practice_type_earnings<span class="sc">$</span>Year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/dispensing_scatter_no_prescribing-2.png" class="img-fluid figure-img" width="1440"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="general-practice-inequalities-datapacks" class="level2">
<h2 class="anchored" data-anchor-id="general-practice-inequalities-datapacks">5. <a href="https://www.heec.co.uk/resource/general-practice-inequalities-datapacks/">General Practice Inequalities Datapacks</a></h2>
<p>There are stark inequalities in the supply, demand and need of general practice. ICBs can take action to address these inequalities.</p>
<p>We’ve developed datapacks for each ICB England to help them understand their inequalities and take action.</p>
<p>Within the datapacks, we calculate the disparity between practices serving the most and least deprived patients for each ICB, across the following categories:</p>
<ul>
<li>Resources (supply): Payments, Workforce</li>
<li>Population (demand): Disease prevalence, Health-related behaviours</li>
<li>Service quality: QOF achievement</li>
<li>Access: Patient experience, Appointments</li>
<li>Impact on secondary care: Emergency admissions, A&amp;E attendances</li>
</ul>
<p>If you’d like a copy of your own ICBs datapack, please email us contact@heec.co.uk</p>
<p>**<a href="https://github.com/HealthEquityEvidenceCentre/HEEC/tree/main/datapacks">datapacks</a></p>
<p><strong><a href="https://health-inequalities.nhsrcommunity.com/england.html">NHS Health Inequalities Notebook</a></strong></p>
</section>
<section id="how-does-the-age-structure-of-patients-affect-nhs-payments-to-general-practice" class="level2">
<h2 class="anchored" data-anchor-id="how-does-the-age-structure-of-patients-affect-nhs-payments-to-general-practice">6. <a href="https://www.heec.co.uk/resource/how-does-the-age-structure-of-patients-affect-nhs-payments-to-general-practice/">How does the age structure of patients affect NHS payments to General Practice?</a></h2>
<p>In 2023/24, 6,669 practices received £10.2 billion from the NHS. Capitation payments to individual practices are adjusted using the Carr-Hill formula. On average, practices received £164.64 per patient, with higher payments for practices serving older populations due to higher healthcare needs, prescribing costs and the specific needs of rural areas. This analysis explores how NHS payments to general practices are informed by the age structure, deprivation and rurality of registered patients.</p>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Chart showing payments per patient by age quintile</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>payment_by_age <span class="ot">&lt;-</span> age_analysis <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(prop65_quintile) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">avg_payment_per_patient =</span> <span class="fu">mean</span>(average_payment_per_patient, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_practices =</span> <span class="fu">n</span>(),</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">quintile_label =</span> <span class="fu">case_when</span>(</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>      prop65_quintile <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Q1 (Youngest)"</span>,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>      prop65_quintile <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Q2"</span>,</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>      prop65_quintile <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"Q3"</span>,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>      prop65_quintile <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Q4"</span>,</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>      prop65_quintile <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Q5 (Oldest)"</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">quintile_label =</span> <span class="fu">factor</span>(quintile_label, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Q1 (Youngest)"</span>, <span class="st">"Q2"</span>, <span class="st">"Q3"</span>, <span class="st">"Q4"</span>, <span class="st">"Q5 (Oldest)"</span>))</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>payment_by_age <span class="sc">%&gt;%</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> quintile_label, <span class="at">y =</span> avg_payment_per_patient, <span class="at">fill =</span> <span class="fu">factor</span>(prop65_quintile))) <span class="sc">+</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> imd_colors,</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">guide =</span> <span class="st">"none"</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"NHS Payments per Patient by Age Structure of Practice Population"</span>,</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Average payment per registered patient by proportion of patients 65+ (quintiles)"</span>,</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Proportion of Patients 65+ (Quintile)"</span>,</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Payment per patient (£)"</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">label_comma</span>(<span class="at">prefix =</span> <span class="st">"£"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/age_payments_chart-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Click to show code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot showing relationship between age and deprivation</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>age_analysis <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Rurality =</span> <span class="fu">case_when</span>(</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>      Practice.Rurality <span class="sc">==</span> <span class="st">"Rural"</span> <span class="sc">~</span> <span class="st">"Rural"</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>      Practice.Rurality <span class="sc">==</span> <span class="st">"Urban"</span> <span class="sc">~</span> <span class="st">"Urban"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Unknown"</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Rurality <span class="sc">!=</span> <span class="st">"Unknown"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Rurality <span class="sc">==</span> <span class="st">"Rural"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> prop65, <span class="at">y =</span> IMD, <span class="at">color =</span> Rurality)) <span class="sc">+</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Rural"</span> <span class="ot">=</span> heec_colors[<span class="dv">6</span>], <span class="st">"Urban"</span> <span class="ot">=</span> heec_colors[<span class="dv">1</span>])</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Relationship between Patient Age Structure and Deprivation"</span>,</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Proportion of patients 65+ vs Index of Multiple Deprivation by rurality"</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Proportion of patients 65+ (%)"</span>,</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Index of Multiple Deprivation (IMD)"</span>,</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Practice Location"</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>),</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">60</span>),</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">60</span>, <span class="at">by =</span> <span class="dv">10</span>)</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>  heec_theme <span class="sc">+</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"bottom"</span></span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="README_files/figure-html/age_imd_scatter-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sorry-were-closed-exploring-general-practice-closures" class="level2">
<h2 class="anchored" data-anchor-id="sorry-were-closed-exploring-general-practice-closures">7. Sorry we’re closed: Exploring general practice closures</h2>
<p>In 2019, there were 7,029 General Practice surgeries in England, providing essential healthcare to more than 60 million patients. However, recent data reveals a concerning trend: this number has fallen by over 10%, leaving just 6,256 practices in operation. While many of these closures represented mergers in with other practices, 193 (24%) shut down completely, leaving no direct replacement. This has displaced an estimated 718,000 – equivalent to nearly 1 in every 80 patients in England – forcing them to seek new healthcare providers.</p>
<p>As the number of surgeries dwindled, the strain on existing practices increased. Over the same period, the average GP list size grew from 8,737 to 9,613 patients. The practices that closed were, on average, significantly smaller, with around 4,004 per surgery. At the same time, the structure of NHS workforce has shifted dramatically, with the number of salaried GPs surpassing the number of GP partners for the first time in NHS history. This shift signals a move away from traditional, independently managed practices toward a system increasingly dominated by large, consolidate healthcare providers.</p>
<!-- - **Code**: [closures](analysis/closures) -->
</section>
</section>
<section id="shiny-applications" class="level1">
<h1>Shiny Applications</h1>
<p>This project includes several interactive Shiny applications for exploring health equity data:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Application</th>
<th>Description</th>
<th>URL</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>QOF Shiny</strong></td>
<td>Quality and Outcomes Framework data explorer</td>
<td><a href="https://camappel.shinyapps.io/QOF_shiny/">camappel.shinyapps.io/QOF_shiny</a></td>
<td>Interactive visualization of QOF disease prevalence and achievement data</td>
</tr>
<tr class="even">
<td><strong>Payments Shiny</strong></td>
<td>NHS payments analysis tool</td>
<td><a href="https://heec.shinyapps.io/Payments_shiny/">heec.shinyapps.io/Payments_shiny</a></td>
<td>Total payments per weighted patient by practice type, ICB, and year</td>
</tr>
<tr class="odd">
<td><strong>Overall Satisfaction</strong></td>
<td>Patient satisfaction explorer</td>
<td><a href="https://heec.shinyapps.io/overall_shiny/">heec.shinyapps.io/overall_shiny</a></td>
<td>Overall satisfaction with General Practice by ICB and year</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Application</th>
<th>Description</th>
<th>URL</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>GPPS App</strong></td>
<td>GP Patient Survey data</td>
<td><a href="https://heec.shinyapps.io/GPPS/">heec.shinyapps.io/GPPS</a></td>
</tr>
<tr class="even">
<td><strong>Access App</strong></td>
<td>Access satisfaction metrics</td>
<td><a href="https://heec.shinyapps.io/access_shiny/">heec.shinyapps.io/access_shiny</a></td>
</tr>
<tr class="odd">
<td><strong>Continuity App</strong></td>
<td>Continuity of care metrics</td>
<td><a href="https://heec.shinyapps.io/continuity_shiny/">heec.shinyapps.io/continuity_shiny</a></td>
</tr>
<tr class="even">
<td><strong>Trust App</strong></td>
<td>Trust in healthcare providers</td>
<td><a href="https://heec.shinyapps.io/trust_shiny/">heec.shinyapps.io/trust_shiny</a></td>
</tr>
<tr class="odd">
<td><strong>Type App</strong></td>
<td>Practice type comparisons</td>
<td><a href="https://heec.shinyapps.io/Type_shiny/">heec.shinyapps.io/Type_shiny</a></td>
</tr>
<tr class="even">
<td><strong>Satisfaction App</strong></td>
<td>General satisfaction metrics</td>
<td><a href="https://heec.shinyapps.io/Satisfaction_shiny/">heec.shinyapps.io/Satisfaction_shiny</a></td>
</tr>
</tbody>
</table>
<p>All applications are designed to explore health inequalities across different deprivation levels, practice types, and geographic regions in England.</p>
</section>
<section id="project-structure" class="level1">
<h1>Project Structure</h1>
<pre><code>├── _quarto.yml          # Project configuration
├── README.qmd           # This main documentation file
├── index.qmd            # Project homepage
├── CLAUDE.md            # Project guidelines and commands
├── analysis/            # Analysis scripts and results
│   ├── age_structure/   # Age demographics analysis
│   ├── closures/        # Practice closure analysis
│   ├── dispensing/      # Dispensing vs non-dispensing practices
│   ├── dispensing_2/    # Extended dispensing analysis
│   ├── healthcare_need/ # Healthcare need assessment
│   └── rurality/        # Rural vs urban analysis
├── data/                # Raw and processed datasets
│   ├── appointments/    # GP appointment data
│   ├── age_group/       # Patient age group data
│   ├── behaviours/      # Health behavior data
│   ├── CQC/            # Care Quality Commission ratings
│   ├── GP_earnings/     # GP income and earnings data
│   ├── IMD/            # Index of Multiple Deprivation
│   ├── life_expectancy/ # Life expectancy data
│   ├── payments/        # NHS payments to practices
│   ├── pcn_workforce/   # Primary Care Network workforce
│   ├── prevalence/      # Disease prevalence data
│   ├── QOF/            # Quality and Outcomes Framework
│   ├── satisfaction/    # Patient satisfaction surveys
│   ├── secondary_care/  # Hospital admissions data
│   └── workforce/       # GP practice workforce data
├── datapacks/           # ICB-specific data reports
│   ├── ICB Reports/     # Individual ICB analysis reports
│   └── Region reports/  # Regional summary reports
└── shiny/              # Interactive Shiny applications
    ├── QOF_shiny/      # Quality metrics explorer
    ├── payments_app/    # NHS payments analysis
    └── satisfaction_overall_app/ # Patient satisfaction</code></pre>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">Getting Started</h2>
<p>To work with this project:</p>
<ol type="1">
<li>Ensure you have R and Quarto installed</li>
<li>Run analysis scripts with: <code>Rscript &lt;script_name&gt;.R</code></li>
<li>Render Quarto documents with: <code>quarto render &lt;document_name&gt;.qmd</code></li>
<li>Launch Shiny apps with: <code>R -e "shiny::runApp('&lt;app_directory&gt;/app.R')"</code></li>
</ol>
<p>For more information, see the <a href="CLAUDE.md">CLAUDE.md</a> file for detailed project guidelines and commands.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/HealthEquityEvidenceCentre\.github\.io\/HEEC\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>